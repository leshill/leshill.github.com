<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title>Les Hill</title>
  <link href="http://feeds2.feedburner.com/leshill" type="application/atom+xml" rel="self" />
  <link href="http://blog.leshill.org/" type="text/html" rel="alternate" />
  <updated>2012-07-17T23:00:41-07:00</updated>
  <author>
    <name>Les Hill</name>
    <email>blog@leshill.org</email>
  </author>
  <id>http://blog.leshill.org/</id>
  
  <entry>
    <title>The Doctor Is In</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2012/04/09/the-doctor-is-in.html" />
    
    <id>tag:blog.leshill.org,2012-04-09:1333955734</id>
    
    <published>2012-04-09T00:15:34-07:00</published>
    <updated>2012-04-09T00:15:34-07:00</updated>
    <content type="html">&lt;h1&gt;Advice from the Doctor, 25¢&lt;/h1&gt;
&lt;p&gt;Would you like someone to help you refactor some of your code? If you are going to be at &lt;a href=&quot;http://railsconf2012.com/&quot;&gt;RailsConf&lt;/a&gt;, then I am happy to pair with you for 30 minutes doing just that.&lt;/p&gt;
&lt;p&gt;We will pair on your machine, on your Ruby/Rails codebase with an existing RSpec/Cucumber test suite. We will refactor code in either your specs or your app. Being a refactor, there should be little to no domain expertise required.&lt;/p&gt;
&lt;h1&gt;The Doctor&amp;#8217;s specialty&lt;/h1&gt;
&lt;p&gt;Refactoring your specs. Specs directly affect the shape of your code.  Well-written specs lead to well-written code. Spending time to refactor your specs pays off dividends immediately in any code base. Unfortunately the last thing on just about everyone&amp;#8217;s list is refactoring the specs. Until the suite is just so painful to work with that something has to be done.&lt;/p&gt;
&lt;p&gt;Refactoring your code. When you are shipping code&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;, there is a gap that occurs between the code you write and ship &lt;strong&gt;now&lt;/strong&gt; versus the code you could have refactored and shipped &lt;strong&gt;later&lt;/strong&gt;&lt;sup class=&quot;footnote&quot; id=&quot;fnr2&quot;&gt;&lt;a href=&quot;#fn2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;. The code is clean, tested, and working but there just happens to be an idiom that everyone uses, or a pattern that can be applied, or a known better (but not more correct) algorithm, or just additional refactoring that has only been enabled by the previous refactors. The shipping tension cuts off those additional refinements&lt;sup class=&quot;footnote&quot; id=&quot;fnr3&quot;&gt;&lt;a href=&quot;#fn3&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;, even those that are trivial in hindsight &amp;#8212; looking at them later makes you wonder why you just did not make the change in the first place.&lt;/p&gt;
&lt;h1&gt;The testimonial&lt;/h1&gt;
&lt;p&gt;In response to this tweet from Steve Klabnik (@steveklabnik):&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet tw-align-center&quot;&gt;&lt;p&gt;Thoughts on improving this spec? &lt;a href=&quot;https://t.co/L73V6vbE&quot; title=&quot;https://github.com/JumpstartLab/donors_choose/blob/master/spec/donors_choose_spec.rb&quot;&gt;github.com/JumpstartLab/d…&lt;/a&gt; Feels awkward. /cc @&lt;a href=&quot;https://twitter.com/garybernhardt&quot;&gt;garybernhardt&lt;/a&gt; @&lt;a href=&quot;https://twitter.com/avdi&quot;&gt;avdi&lt;/a&gt; @&lt;a href=&quot;https://twitter.com/gregmoeck&quot;&gt;gregmoeck&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&amp;mdash; Steve Klabnik (@steveklabnik) &lt;a href=&quot;https://twitter.com/steveklabnik/status/169512925839630337&quot; data-datetime=&quot;2012-02-14T20:06:45+00:00&quot;&gt;February 14, 2012&lt;/a&gt;&lt;/blockquote&gt;&lt;br /&gt;
&lt;script src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;&lt;/p&gt;
&lt;p&gt;I quickly offered a &lt;a href=&quot;http://git.io/42FOsw&quot;&gt;spike&lt;/a&gt; showing how to restructure the code:&lt;/p&gt;
&lt;blockquote class=&quot;twitter-tweet tw-align-center&quot; data-in-reply-to=&quot;169512925839630337&quot;&gt;&lt;p&gt;@&lt;a href=&quot;https://twitter.com/steveklabnik&quot;&gt;steveklabnik&lt;/a&gt; FWIW, I agree with @&lt;a href=&quot;https://twitter.com/garybernhardt&quot;&gt;garybernhardt&lt;/a&gt;, the examples are awkward &amp;#8211; they test too much, try an impl like: &lt;a href=&quot;http://t.co/4JjHmLn8&quot; title=&quot;http://git.io/42FOsw&quot;&gt;git.io/42FOsw&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&amp;mdash; Les Hill (@leshill) &lt;a href=&quot;https://twitter.com/leshill/status/169521240699174913&quot; data-datetime=&quot;2012-02-14T20:39:47+00:00&quot;&gt;February 14, 2012&lt;/a&gt;&lt;/blockquote&gt;&lt;br /&gt;
&lt;script src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;&lt;/p&gt;
&lt;h1&gt;How much is it?&lt;/h1&gt;
&lt;p&gt;It&amp;#8217;s free!&lt;/p&gt;
&lt;p&gt;Seeing a random (and statistically meaningless :) sample of real world code is research for my next talk: &lt;strong&gt;Be Happier, Write Better Code&lt;/strong&gt;. Real world code is code written under commercial stresses, from the intentional: &lt;em&gt;Lean Startup!&lt;/em&gt; to the unintentional: &lt;em&gt;Conway&amp;#8217;s Law&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;The goal is to see what real world code looks like.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;What kind of shape it is in.&lt;/li&gt;
	&lt;li&gt;What the style is.&lt;/li&gt;
	&lt;li&gt;What idioms are used.&lt;/li&gt;
	&lt;li&gt;What idioms are not used.&lt;/li&gt;
	&lt;li&gt;What patterns are used.&lt;/li&gt;
	&lt;li&gt;What is missing.&lt;/li&gt;
	&lt;li&gt;What the testing philosphy is.&lt;/li&gt;
	&lt;li&gt;What is overwrought and over-engineered.&lt;/li&gt;
	&lt;li&gt;What do the commits look like.&lt;/li&gt;
	&lt;li&gt;What happens in bug-fixes.&lt;/li&gt;
	&lt;li&gt;The list goes on.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;At no point are you giving anyone else access to your code&lt;sup class=&quot;footnote&quot; id=&quot;fnr4&quot;&gt;&lt;a href=&quot;#fn4&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;. No identifying information will be used for the talk. Only you and I will be examining the code (there is no audience participation.)&lt;/p&gt;
&lt;h1&gt;Call now!&lt;/h1&gt;
&lt;p&gt;Here are the rules:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A Ruby/Rails codebase.&lt;/li&gt;
	&lt;li&gt;An existing RSpec/Cucumber test suite.&lt;/li&gt;
	&lt;li&gt;One problem that you would like to refactor, either in your code or in your specs.&lt;/li&gt;
	&lt;li&gt;You understand that there is a time limit of 30 minutes.&lt;/li&gt;
	&lt;li&gt;The problem is not domain-related (there are only 30 minutes available.)&lt;/li&gt;
	&lt;li&gt;Have all of this ready to work with on your machine.&lt;/li&gt;
	&lt;li&gt;You drive the whole time on your codebase and your machine.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To get started, sign into &lt;a href=&quot;https://www.privatelyapp.com&quot;&gt;PrivatelyApp.com&lt;/a&gt; with your Twitter account and start a private conversation with &lt;strong&gt;@leshill&lt;/strong&gt;. In private and in more than 140 characters tell me how I can help you.&lt;/p&gt;
&lt;p&gt;If we come to an agreement, we will pick a 30 minute time slot. I am leaning towards time slots in the evenings (6 to 11 p.m.) on either Monday April 23, or Tuesday April 24.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; &lt;strong&gt;Code&lt;/strong&gt; that is &lt;em&gt;clean&lt;/em&gt;, &lt;em&gt;tested&lt;/em&gt;, and &lt;em&gt;working&lt;/em&gt; &amp;#8212; sloppy, untested code that just happens to work is at best an experiment.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn2&quot;&gt;&lt;a href=&quot;#fnr2&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; Let&amp;#8217;s call this gap &lt;strong&gt;Working Code Wins&lt;/strong&gt;. An observation that a shipping trade-off was made. Another post perhaps?&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn3&quot;&gt;&lt;a href=&quot;#fnr3&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt; &lt;strong&gt;Technical Debt&lt;/strong&gt; is a related concept. Originally, &lt;strong&gt;Technical Debt&lt;/strong&gt; meant coding your existing but incomplete understanding, and then modifying the code with the insight and understanding gained from experience; paying down the debt of your incomplete understanding. Now &lt;strong&gt;Technical Debt&lt;/strong&gt; has been abused and diluted to mean anything undesirable in a codebase.&lt;/p&gt;
&lt;p&gt;A more useful definition is deliberately choosing deficient designs or algorithms to acheive short-term goals. For example, implementing a simplistic and unscalable algorithm instead of a robust, complex, and scalable algorithm because you have 5 users and not 1 million users. If, by happy chance, you start up the hockey stick, you will have to pay that &lt;strong&gt;Technical Debt&lt;/strong&gt; off. The debt comes in two forms: you implement the more complex algorithm anyway, and the implementation may turn out to be more difficult in the existing codebase than if it had been implemented up front.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn4&quot;&gt;&lt;a href=&quot;#fnr4&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt; The code never leaves your machine and you are the only person touching it.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>A Question of Truth</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2012/03/25/a-question-of-truth.html" />
    
    <id>tag:blog.leshill.org,2012-03-25:1332709513</id>
    
    <published>2012-03-25T14:05:13-07:00</published>
    <updated>2012-03-25T14:05:13-07:00</updated>
    <content type="html">&lt;p&gt;Yesterday, a simple pull request to Rails &lt;a href=&quot;https://github.com/rails/rails/pull/5329&quot;&gt;core&lt;/a&gt; &lt;a href=&quot;https://github.com/rails/rails/commit/0aa66f04e4b4698718023cacb18612e04a4c5eb1&quot;&gt;dramatically&lt;/a&gt; &lt;a href=&quot;https://github.com/rails/rails/pull/5572&quot;&gt;exploded&lt;/a&gt; over the issue of what a predicate should return.&lt;/p&gt;
&lt;h2&gt;TL;DR&lt;/h2&gt;
&lt;p&gt;This tweet pretty much sums it up:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;For what it&amp;#8217;s worth I&amp;#8217;d consider any ruby code that relies on true/false singletons from predicates to be in error.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&amp;mdash; &lt;a href=&quot;https://twitter.com/#!/avdi/status/183376469957943296&quot;&gt;@avdi&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;To really appreciate the dicussion, we need to know two things about Ruby.&lt;/p&gt;
&lt;h3&gt;What is true?&lt;/h3&gt;
&lt;p&gt;Ruby, like many programming languages, has a specific understanding of &lt;em&gt;true&lt;/em&gt; or &lt;em&gt;false&lt;/em&gt; that goes beyond expressing the concept in a boolean type. Ruby understands the concept of whether a value is &lt;em&gt;true&lt;/em&gt; or &lt;em&gt;false&lt;/em&gt;, and therefore any expression requiring a boolean value (for example, using the boolean logic operators), without needing an explicit set of boolean values. Ruby does have the keywords &lt;code&gt;true&lt;/code&gt; and &lt;code&gt;false&lt;/code&gt;, sometimes called the &lt;em&gt;true singleton&lt;/em&gt; and the &lt;em&gt;false singleton&lt;/em&gt; since the values are shared in the Ruby VM, which are Ruby&amp;#8217;s only notion of anything like a boolean type.&lt;/p&gt;
&lt;p&gt;Instead, in Ruby, when a boolean value is required in boolean logic expressions (or conditionals), Ruby is really only concered with the &lt;em&gt;truthyness&lt;/em&gt; of the value.  Ruby evaluates a value as either &lt;em&gt;truthy&lt;/em&gt; or &lt;em&gt;falsey&lt;/em&gt; with a simple rule.&lt;/p&gt;
&lt;p&gt;All of the following are &lt;em&gt;falsey&lt;/em&gt; values.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;code&gt;false&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;nil&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And anything else is a &lt;em&gt;truthy&lt;/em&gt; value:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;-1&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;0&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;0.0&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;&quot;&quot;&lt;/code&gt; &amp;mdash; an empty string&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;&quot;hi&quot;&lt;/code&gt; &amp;mdash; a non-empty string&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;[]&lt;/code&gt; &amp;mdash; an empty array&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;{a: 1}&lt;/code&gt; &amp;mdash; a non-empty hash&lt;/li&gt;
	&lt;li&gt;&lt;code&gt;Object.new&lt;/code&gt; &amp;mdash; any object&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;You get the idea&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is one of Ruby&amp;#8217;s many affordances for developers (and not the only one at play in this drama). It allows us to write concise and expressive code like this:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; might_be_initialized_already ||= {}&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;To be very clear about what this is doing, lets rewrite it naively:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;unless&lt;/span&gt; might_be_initialized_already
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt;   might_be_initialized_already = {}
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Note that we do not care what the type of &lt;code&gt;might_be_initialized_already&lt;/code&gt; is, we can use the incredibly useful definition of &lt;em&gt;truthy&lt;/em&gt; and &lt;em&gt;falsey&lt;/em&gt; to evaluate the conditional without coercion or other type-based manipulations.&lt;/p&gt;
&lt;h3&gt;What is a predicate?&lt;/h3&gt;
&lt;p&gt;Ruby has, among its many affordances for developers (and the second one at play in this drama), the optional method name suffixes &lt;code&gt;!&lt;/code&gt; and &lt;code&gt;?&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;At this point, you might be thinking, &amp;#8220;&lt;em&gt;Hey what about &lt;code&gt;=&lt;/code&gt;, it is also a suffix!&lt;/em&gt;&amp;#8221; and you would be almost right. &lt;code&gt;=&lt;/code&gt; is a suffix, but unlike &lt;code&gt;!&lt;/code&gt; and &lt;code&gt;?&lt;/code&gt; it actually means something to Ruby, namely that expressions like our earlier example:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.properties ||= {}&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;are understood correctly. &lt;code&gt;!&lt;/code&gt; and &lt;code&gt;?&lt;/code&gt; mean nothing to Ruby, they exist to make our code just a bit more pleasant to read. &lt;code&gt;!&lt;/code&gt; and &lt;code&gt;?&lt;/code&gt; are affordances that we use by convention. There is no requirement to use them, yet we do so all the time. And yes, &lt;code&gt;=&lt;/code&gt; is another one of those affordances for the developer.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;!&lt;/code&gt; suffix indicates that the method modifies the receiver, for example:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;reset!&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# reset everything back to its initial state&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The convention for &lt;code&gt;!&lt;/code&gt; is summed up in &lt;strong&gt;Programming Ruby&lt;/strong&gt; by Thomas&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Methods that are “dangerous,” or modify the receiver, may be named with a trailing !.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The &lt;code&gt;?&lt;/code&gt; suffix indicates that the method is a predicate, returning a &lt;em&gt;truthy&lt;/em&gt; or &lt;em&gt;falsey&lt;/em&gt; value. For example:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; reset! &lt;span class=&quot;r&quot;&gt;unless&lt;/span&gt; valid?&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The convention for &lt;code&gt;?&lt;/code&gt; is also summed up in &lt;strong&gt;Programming Ruby&lt;/strong&gt; by Thomas:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Methods that act as queries are often named with a trailing ?, such as &lt;code&gt;instance_of?&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The astute reader will have noted that &lt;em&gt;by definition&lt;/em&gt; &lt;strong&gt;every method in ruby returns a &lt;em&gt;truthy&lt;/em&gt; or &lt;em&gt;falsey&lt;/em&gt; value&lt;/strong&gt;. And in &lt;strong&gt;The Ruby Programming Language&lt;/strong&gt; by Flannagan and Matz (yes, that Matz), it is noted as part of the convention for &lt;code&gt;?&lt;/code&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Predicates typically return one of the Boolean values true or false, but this is not required, as any value other than false or nil works like true when a Boolean value is required. (The Numeric method nonzero?, for example, returns nil if the number it is invoked on is zero, and just returns the number otherwise.)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;The drama&lt;/h2&gt;
&lt;p&gt;The pull request in question reverted year-old Rails code, changing it to return &lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt; instead of just returning a &lt;em&gt;truthy&lt;/em&gt; or &lt;em&gt;falsey&lt;/em&gt; value. The instigation of the request was that originally the &lt;code&gt;xml_http_request?&lt;/code&gt; method returned &lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt; and existing code had used the predicate as a RHS. When the value constraint was removed, all the code using the predicate as a RHS caused errors (the values were no longer &lt;code&gt;true&lt;/code&gt; and &lt;code&gt;false&lt;/code&gt;).&lt;/p&gt;
&lt;h2&gt;My opinion&lt;/h2&gt;
&lt;p&gt;Since a predicate method is only a method with a &amp;#8216;?&amp;#8217; appended to the name, the convention around its use covers two questions, the obvious one:&lt;/p&gt;
&lt;h3&gt;What values does the predicate method return?&lt;/h3&gt;
&lt;p&gt;We might say that the convention is that the predicate method constrains its return value to &lt;code&gt;true&lt;/code&gt; and &lt;code&gt;false&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Or we might say that the convention is that the predicate method does not constrain its value.&lt;/p&gt;
&lt;p&gt;Given the explicit endorsement, the second is clearly the convention. This also matches the experience of the Ruby community to date.&lt;/p&gt;
&lt;p&gt;As an aside, following the precedent of &lt;code&gt;=&lt;/code&gt;, one can easily imagine a modified Ruby that would make predicate methods returning only &lt;code&gt;true&lt;/code&gt; and &lt;code&gt;false&lt;/code&gt; more than just a convention and simply the way Ruby works.&lt;sup class=&quot;footnote&quot; id=&quot;fnr2&quot;&gt;&lt;a href=&quot;#fn2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;And the not so obvious one:&lt;/p&gt;
&lt;h3&gt;When do you use the predicate method?&lt;/h3&gt;
&lt;p&gt;If we accept that the predicate method constrains its return value, then accepting that the predicate method is usable anywhere makes sense. In this case using a predicate as a RHS is perfect when you want to get a &lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt; value.&lt;/p&gt;
&lt;p&gt;If we accept that the predicate method does not constrain its return value, then accepting that the predicate method is usable anywhere does not make sense. In this case using a predicate as a RHS fails miserably, as you get whatever happens to be returned when determining its &lt;em&gt;truthyness&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;This is really the cause of the dust-up in Rails core. Whatever the original intentions were, at one point the predicate method in question returned &lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt;. Depending on a predicate method to return a &lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt; for use in a RHS is not really good Ruby practice. There is no guarantee that the values are anything other than &lt;em&gt;truthy&lt;/em&gt; or &lt;em&gt;falsey&lt;/em&gt;, which is to say, anything at all.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; The Pickaxe book.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn2&quot;&gt;&lt;a href=&quot;#fnr2&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; Just in case someone misreads that sentence, Ruby does not work this way.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Fast Specs!</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2011/10/23/fast-specs.html" />
    
    <id>tag:blog.leshill.org,2011-10-23:1319432489</id>
    
    <published>2011-10-23T22:01:29-07:00</published>
    <updated>2011-10-23T22:01:29-07:00</updated>
    <content type="html">&lt;h1&gt;Fast Specs!&lt;/h1&gt;
&lt;p&gt;Nothing sucks the joy out of writing your Rails app like having an incredibly slow test suite. Even running one file with a single spec on my &lt;em&gt;new&lt;/em&gt; MacBookPro takes almost five seconds!&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% time rspec spec/models/publish_spec.rb
.&lt;/code&gt;

&lt;code&gt;Finished in 4.48 seconds
1 example, 0 failures&lt;/code&gt;

&lt;code&gt;real    0m4.592s
user    0m3.990s
sys     0m0.536s&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Wait, maybe we can just run &lt;code&gt;ruby&lt;/code&gt;?&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% time ruby -Ispec spec/models/publish_spec.rb
.&lt;/code&gt;

&lt;code&gt;Finished in 0.71331 seconds
1 example, 0 failures&lt;/code&gt;

&lt;code&gt;real    0m4.468s
user    0m3.953s
sys     0m0.512s&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Five.&lt;/p&gt;
&lt;p&gt;Seconds.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;F I V E  SECONDS&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;One Mississippi&lt;/em&gt;, &lt;em&gt;Two Mississippi&lt;/em&gt;, &lt;em&gt;Three Mississippi&lt;/em&gt;, &lt;em&gt;Four Mississippi&lt;/em&gt;, &lt;em&gt;Five Mississippi&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;An eternity.&lt;/p&gt;
&lt;p&gt;Let&amp;#8217;s take a look at the admittedly ridiculous and contrived spec:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; it &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;publishes the item to the syndicate&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt;   syndicate = double()
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt;   syndicate.should_receive(&lt;span class=&quot;sy&quot;&gt;:publish&lt;/span&gt;).with(item)
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt;   item.publish_to(syndicate)
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Maybe there is a &lt;code&gt;sleep&lt;/code&gt; hiding inside &lt;code&gt;#publish_to&lt;/code&gt;?&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;publish_to&lt;/span&gt;(syndicate)
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt;   syndicate.publish(&lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Nope.&lt;/p&gt;
&lt;p&gt;Very little of the time spent has to do with either the code under test, or the testing code. The majority of the time is just getting the test to run.&lt;/p&gt;
&lt;p&gt;The source of most of this is the default &lt;code&gt;spec_helper.rb&lt;/code&gt; that &lt;strong&gt;RSpec&lt;/strong&gt; generates to load up our test environment.&lt;/p&gt;
&lt;p&gt;Asking around about this on Twitter (you should follow me &lt;a href=&quot;http://twitter.com/leshill&quot;&gt;@leshill&lt;/a&gt; :) yielded no examples on how you might write your specs to get some of that time back. So I wrote the &lt;a href=&quot;http://github.com/leshill/fast_specs&quot;&gt;fast_specs&lt;/a&gt; app (it is available on &lt;a href=&quot;http://github.com/leshill/fast_specs&quot;&gt;github&lt;/a&gt;) to demonstrate how to make your own specs faster.&lt;/p&gt;
&lt;h2&gt;Writing Fast Specs&lt;/h2&gt;
&lt;p&gt;The &lt;strong&gt;fast_specs&lt;/strong&gt; app has two spec suites, one a normal &lt;strong&gt;RSpec&lt;/strong&gt; suite that can be invoked as a whole with:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% rake spec&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Or invoked with individual specs with:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% rspec spec/models/publish_spec.rb
% ruby -Ispec spec/models/publish_spec.rb&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And a &lt;strong&gt;Fast Spec&lt;/strong&gt; suite that can be invoked as a whole with:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% rake fast&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Or invoked with individual specs with:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% rspec -Ifast_specs fast_specs/models/publish_spec.rb&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In order to use the &lt;strong&gt;Fast Spec&lt;/strong&gt; suite, we put our &lt;em&gt;fast&lt;/em&gt; specs under &lt;code&gt;fast_specs&lt;/code&gt; much like we do with normal &lt;strong&gt;RSpec&lt;/strong&gt; specs. For example, the spec for the &lt;code&gt;Publish&lt;/code&gt; model would be located at &lt;code&gt;fast_specs/models/publish_spec.rb&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;At the top of our simple spec, with no changes to the implementation or the contents of the &lt;code&gt;describe&lt;/code&gt; block, we require the &lt;code&gt;fast_spec_helper&lt;/code&gt;, and the &lt;code&gt;Publish&lt;/code&gt; model:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fast_spec_helper&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; app_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;app/models/publish&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;code&gt;fast_spec_helper&lt;/code&gt; adds a tiny bit of sugar by providing &lt;code&gt;app_require&lt;/code&gt; which just wraps loading files from your app.&lt;/p&gt;
&lt;p&gt;Now when we run it:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% time rspec -Ifast_specs fast_specs/models/publish_spec.rb
  .&lt;/code&gt;

&lt;code&gt;  real    0m0.249s
  user    0m0.183s
  sys     0m0.064s&lt;/code&gt;

&lt;code&gt;  Finished in 0.17153 seconds
  1 example, 0 failures&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;One quarter of a second.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Oh point two five&lt;/em&gt; seconds.&lt;/p&gt;
&lt;p&gt;Much faster.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;GO!&lt;/strong&gt; &lt;strong&gt;FAST&lt;/strong&gt; &lt;strong&gt;FASTER&lt;/strong&gt; &lt;strong&gt;FASTEST&lt;/strong&gt; &lt;strong&gt;GO!&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Give me some support&lt;/h2&gt;
&lt;p&gt;Sometimes our code has some coupling to other parts of the system, and in those cases, we can just require the parts that we need during our spec. For example, if our &lt;code&gt;Post&lt;/code&gt; depends on &lt;code&gt;Publish&lt;/code&gt; our requires would look like:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fast_spec_helper&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; app_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;app/models/publish&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt; app_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;app/models/post&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Not all specs are written completely with mocks (although more should be), and sometimes we need additional setup. For example, lets say that we are moving an existing &lt;em&gt;classic&lt;/em&gt; TDD model spec (again, completely contrived) for our &lt;code&gt;Post&lt;/code&gt; that looks like this:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; it &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;creates a post&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt;   expect &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt;     &lt;span class=&quot;co&quot;&gt;Post&lt;/span&gt;.create(&lt;span class=&quot;sy&quot;&gt;title:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;a title&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;sy&quot;&gt;body:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;some body text&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;.to change(&lt;span class=&quot;co&quot;&gt;Post&lt;/span&gt;, &lt;span class=&quot;sy&quot;&gt;:count&lt;/span&gt;).from(&lt;span class=&quot;i&quot;&gt;0&lt;/span&gt;).to(&lt;span class=&quot;i&quot;&gt;1&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;This spec requires accessing the database and ensuring some sort of &lt;em&gt;transactional fixture&lt;/em&gt; support. We can write these support files, place them in them in &lt;code&gt;fast_specs/support&lt;/code&gt; and then require them using another tiny bit of sugar with &lt;code&gt;support_require&lt;/code&gt; to load our support files:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fast_spec_helper&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; support_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;database&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt; support_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;database_cleaner&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;6&lt;/span&gt; app_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;app/models/publish&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;7&lt;/span&gt; app_require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;app/models/post&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Timing this spec (which is using a transaction on the database) yields:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% time rspec -Ifast_specs fast_specs/models/post_spec.rb
.&lt;/code&gt;

&lt;code&gt;Finished in 0.80608 seconds
1 example, 0 failures&lt;/code&gt;

&lt;code&gt;real    0m0.890s
user    0m0.701s
sys     0m0.170s&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Not bad. And most definitely faster than our previous isolated spec was :)&lt;/p&gt;
&lt;h3&gt;Make this better!&lt;/h3&gt;
&lt;p&gt;This is only the beginning of making your specs faster. Yes, shaving 4 seconds off when running an individual spec is fantastic. If you have suggestions for more techniques or code that helps even further, make a pull request!&lt;/p&gt;
&lt;h2&gt;Thanks&lt;/h2&gt;
&lt;p&gt;The approach outlined here is something that I just made up out of sheer frustration with the ridiculousness of waiting &lt;strong&gt;5 seconds&lt;/strong&gt; for a simple spec.&lt;/p&gt;
&lt;p&gt;The idea of replacing the &lt;code&gt;spec_helper.rb&lt;/code&gt; was first mentioned to me by Gary Bernhardt over dinner a while back. Corey Haines has also been advocating this approach in some of his talks (and which I would love to see one of these days :)&lt;/p&gt;
&lt;p&gt;And I know there was a blog post that suggested some serious stubbing for ActionController a while back (I cannot find it now, if you know it, please ping me.)&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Write Your Own Gemspec</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2011/08/21/write-your-own-gemspec.html" />
    
    <id>tag:blog.leshill.org,2011-08-21:1313971982</id>
    
    <published>2011-08-21T17:13:02-07:00</published>
    <updated>2011-08-21T17:13:02-07:00</updated>
    <content type="html">&lt;p&gt;This blog post was inspired by &lt;a href=&quot;http://twiiter.com/garybernhardt&quot;&gt;@garybernhardt&lt;/a&gt;&amp;#8217;s &lt;a href=&quot;http://twitter.com/#!/garybernhardt/status/104716358092201985&quot;&gt;tweet&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Coming in a few minutes: my first actual Ruby gem. If I can figure out how to publish it.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In the distant past, I would have suggested to Gary that he use &lt;a href=&quot;http://rubygems.org/gems/jeweler&quot;&gt;Jeweler&lt;/a&gt; when starting a new Ruby Gem. Then one day I was deep in a conversation with Durran Jordan (&lt;a href=&quot;http://twitter.com/modetojoy&quot;&gt;@modetojoy&lt;/a&gt;) about some minutae of MongoDB and Mongoid when the topic of starting a new gem came up. Durran&amp;#8217;s reaction was stated with his usual aplomb:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Jeweller? Hoe? F*#!k that noise. Write your own gemspec and be done.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;When Durran says something, it is worth listening to. I went back and ripped out Jeweler. The world did not end. I published my gem. I even found I had a bunch of unnecessary baggage. Getting rid of Jeweler actually improved my understanding of the gem publishing process.&lt;/p&gt;
&lt;h2&gt;How to publish your gem&lt;/h2&gt;
&lt;p&gt;Publishing a gem is basically a three step process:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Gem layout and Gemspec generation&lt;/li&gt;
	&lt;li&gt;First push&lt;/li&gt;
	&lt;li&gt;Subsequent pushes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Well, except for the &lt;em&gt;zeroth&lt;/em&gt; step: deciding on a gem name. It is well worth spending a little time googling and taking a look at existing &lt;a href=&quot;http://rubygems.org&quot;&gt;RubyGems.org&lt;/a&gt; before choosing your name.&lt;/p&gt;
&lt;h2&gt;Gem layout and Gemspec generation&lt;/h2&gt;
&lt;p&gt;The hard way to do this is to find another gem and copy its gemspec and layout.&lt;/p&gt;
&lt;p&gt;Or we can cheat.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Bundler&lt;/strong&gt; will generate a gemspec and a layout for you&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;. And since we are cheating already, lets use use &lt;strong&gt;rvm&lt;/strong&gt; as well, shall we?&lt;sup class=&quot;footnote&quot; id=&quot;fnr2&quot;&gt;&lt;a href=&quot;#fn2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;. You can follow along with this not-yet-released gem &lt;a href=&quot;http://github.com/leshill/handlebars_assets&quot;&gt;handlebars_assets&lt;/a&gt;&lt;sup class=&quot;footnote&quot; id=&quot;fnr3&quot;&gt;&lt;a href=&quot;#fn3&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;. Here is what we are going to do:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create a gemset for &lt;em&gt;your_gem&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;Install bundler&lt;/li&gt;
	&lt;li&gt;Create the gem layout&lt;/li&gt;
	&lt;li&gt;Create the &lt;code&gt;.rvmrc&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;Remove &lt;code&gt;Gemfile.lock&lt;/code&gt; from &lt;code&gt;.gitignore&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;Make the initial commit&lt;/li&gt;
	&lt;li&gt;Edit the gemspec as needed&lt;/li&gt;
	&lt;li&gt;Install all your dependencies&lt;/li&gt;
	&lt;li&gt;Commit your changes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Easy!&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% rvm gemset create your_gem
% rvm gemset use your_gem
% gem install bundler
% bundle gem your_gem
% cd your_gem
% cat &amp;gt; .rvmrc
rvm use default@your_gem&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Edit &lt;code&gt;.gitignore&lt;/code&gt; to remove Gemfile.lock from the list of ignores.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% git add .
% git commit -m 'Initial commit'&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We now need to edit our generated &lt;a href=&quot;http://docs.rubygems.org/read/chapter/20&quot;&gt;gemspec&lt;/a&gt;. There are three basic parts to the gemspec:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Metadata&lt;/li&gt;
	&lt;li&gt;Manifest&lt;/li&gt;
	&lt;li&gt;Dependencies&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Our generated gemspec has placeholder metadata, a good starting manifest, and no dependencies.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# -*- encoding: utf-8 -*-&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 2&lt;/span&gt; &lt;span class=&quot;gv&quot;&gt;$:&lt;/span&gt;.push &lt;span class=&quot;co&quot;&gt;File&lt;/span&gt;.expand_path(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;../lib&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;pc&quot;&gt;__FILE__&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt; 3&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;your_gem/version&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 4&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 5&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;Gem&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;Specification&lt;/span&gt;.new &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt; |s|
&lt;span class=&quot;no&quot;&gt; 6&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# Metadata&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 7&lt;/span&gt;   s.name        = &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;your_gem&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 8&lt;/span&gt;   s.version     = &lt;span class=&quot;co&quot;&gt;YourGem&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;VERSION&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 9&lt;/span&gt;   s.authors     = [&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Your Name&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;10&lt;/strong&gt;&lt;/span&gt;   s.email       = [&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;your_name@example.com&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;11&lt;/span&gt;   s.homepage    = &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;12&lt;/span&gt;   s.summary     = &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;%q{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;TODO: Write a gem summary&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;13&lt;/span&gt;   s.description = &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;%q{&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;TODO: Write a gem description&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;14&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;15&lt;/span&gt;   s.rubyforge_project = &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;your_gem&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;16&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;17&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# Manifest&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;18&lt;/span&gt;   s.files         = &lt;span class=&quot;sh&quot;&gt;&lt;span class=&quot;dl&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;git ls-files&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;`&lt;/span&gt;&lt;/span&gt;.split(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;19&lt;/span&gt;   s.test_files    = &lt;span class=&quot;sh&quot;&gt;&lt;span class=&quot;dl&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;git ls-files -- {test,spec,features}/*&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;`&lt;/span&gt;&lt;/span&gt;.split(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;20&lt;/strong&gt;&lt;/span&gt;   s.executables   = &lt;span class=&quot;sh&quot;&gt;&lt;span class=&quot;dl&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;git ls-files -- bin/*&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;`&lt;/span&gt;&lt;/span&gt;.split(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;).map{ |f| &lt;span class=&quot;co&quot;&gt;File&lt;/span&gt;.basename(f) }
&lt;span class=&quot;no&quot;&gt;21&lt;/span&gt;   s.require_paths = [&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;lib&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;22&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;23&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# Dependencies&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;24&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# specify any dependencies here; for example:&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;25&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# s.add_development_dependency &amp;quot;rspec&amp;quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;26&lt;/span&gt;   &lt;span class=&quot;c&quot;&gt;# s.add_runtime_dependency &amp;quot;rest-client&amp;quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;27&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Edit the metadata to include your name, email, and what the gem is about. Unless you are doing something off the reservation, there should be no need to mess with the manifest.&lt;/p&gt;
&lt;p&gt;The gemspec allows you to specify both runtime and development dependencies. Runtime dependencies are what the users of your gem will need installed with the gem. Development dependencies are used by developers working on your gem, for example gems used for testing only such as RSpec and Cucumber. Add the dependencies you know. You can change the dependency list later easily. &lt;strong&gt;Important!&lt;/strong&gt; Do not  edit the &lt;code&gt;Gemfile&lt;/code&gt;, bundler knows how to read the gemspec.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% bundle
% git commit -a&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now comes the hard part, actually writing your gem.&lt;/p&gt;
&lt;h2&gt;First push&lt;/h2&gt;
&lt;p&gt;After you have written you gem&amp;#8217;s initial code, you will want to push it out for people to use. There are two things to know about this process:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;You need a &lt;a href=&quot;http://rubygems.org&quot;&gt;RubyGems.org&lt;/a&gt; account&lt;/li&gt;
	&lt;li&gt;It is ridiculously easy&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Once you have your RubyGems account, lets build and push the gem using the &lt;code&gt;gem&lt;/code&gt; command. When you push, you will be asked to log into RubyGems one time. After that, your credentials will be saved for future use.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% gem build your_gem.gemspec
% gem push your_gem-0.0.1.gem
Enter your RubyGems.org credentials.
Don't have an account yet? Create one at http://rubygems.org/sign_up
   Email:   your_name@example.com
Password:
Pushing gem to https://rubygems.org...
Signed in.
Pushing gem to https://rubygems.org...
Successfully registered gem: your_gem (0.0.1)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Congratulations on publishing your gem!&lt;/p&gt;
&lt;h2&gt;Subsequent pushes&lt;/h2&gt;
&lt;p&gt;On subsequent pushes you will need to manage your version number. There are also two things to know about this process:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The version number is in &lt;code&gt;lib/your_gem/version.rb&lt;/code&gt;&lt;/li&gt;
	&lt;li&gt;It is ridiculously easy&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Update (but do not commit) your version number in &lt;code&gt;lib/your_gem/version.rb&lt;/code&gt;. If you have any other outstanding changes, commit those first &amp;mdash; we want our version number commit to be atomic and we are going to tag it. Now do this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% bundle
% git commit -am 'v0.0.2'
% git tag 'v0.0.2'
% gem build your_gem.gemspec
% gem push your_gem-0.0.2.gem&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Running bundle before the commit updates the version numbers in the Gemfile.lock file. Your git history will look nice and clean with your spiffy new atomic version commits!&lt;/p&gt;
&lt;p&gt;Durran was right: just write the gemspec and be done.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; Not using Bundler? Do it the hard way. Better yet, use Bundler.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn2&quot;&gt;&lt;a href=&quot;#fnr2&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; Not using &lt;code&gt;rvm&lt;/code&gt;? Why not? At least tell me you are using &lt;code&gt;rbenv&lt;/code&gt;?&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn3&quot;&gt;&lt;a href=&quot;#fnr3&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt; This repo is currently (8/22/11) missing the &lt;code&gt;README.md&lt;/code&gt;, you should have one.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>jQuery Validation plugin and Backbone</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2011/08/14/jquery-validation-plugin-and-backbone.html" />
    
    <id>tag:blog.leshill.org,2011-08-14:1313351271</id>
    
    <published>2011-08-14T12:47:51-07:00</published>
    <updated>2011-08-14T12:47:51-07:00</updated>
    <content type="html">&lt;p&gt;Ready for some heresy? Let&amp;#8217;s validate a &lt;a href=&quot;http://documentcloud.github.com/backbone/&quot;&gt;Backbone.js&lt;/a&gt; model using the &lt;a href=&quot;http://docs.jquery.com/Plugins/validation&quot;&gt;jQuery Validation plugin&lt;/a&gt; and a &lt;code&gt;View&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;If you are interested in the heresy, skip to the bottom.&lt;/p&gt;
&lt;p&gt;Here is a simple sign up form for a Rails app. We want to validate that the user has entered an email address and filled in the password. Additionally, we would like to know if the email entered is available, so we will use AJAX to call down to the server to check availability dynamically.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;ta&quot;&gt;&amp;lt;form&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;accept-charset&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;UTF-8&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;action&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;validate&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new_user&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;method&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 2&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;style&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;margin:0;padding:0;display:inline&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 3&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;input&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;utf8&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;hidden&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;✓&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 4&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;input&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;authenticity_token&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;hidden&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;dkjfhioeutgdkjdkfj&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 5&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 6&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 7&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;label&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;for&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user_email&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;Your email&lt;span class=&quot;ta&quot;&gt;&amp;lt;/label&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 8&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;input&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;text required email&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user_email&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[email]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;size&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 9&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;10&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;11&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;label&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;for&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user_password&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;Choose a password&lt;span class=&quot;ta&quot;&gt;&amp;lt;/label&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;12&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;input&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;autocomplete&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;off&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;text required&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user_password&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[password]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;size&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;13&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;14&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;p&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;buttons&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;15&lt;/span&gt;     &lt;span class=&quot;ta&quot;&gt;&amp;lt;input&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;submit&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;an&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Get started&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;ta&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;16&lt;/span&gt;   &lt;span class=&quot;ta&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;17&lt;/span&gt; &lt;span class=&quot;ta&quot;&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;As a starting point, this is how we might use Validation with jQuery to validate our form.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;pd&quot;&gt;$&lt;/span&gt;(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;#new_user&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;).validate({
&lt;span class=&quot;no&quot;&gt; 2&lt;/span&gt;   &lt;span class=&quot;ke&quot;&gt;rules&lt;/span&gt;: {
&lt;span class=&quot;no&quot;&gt; 3&lt;/span&gt;     &lt;span class=&quot;ke&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[email]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;: {
&lt;span class=&quot;no&quot;&gt; 4&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;required&lt;/span&gt;: &lt;span class=&quot;pc&quot;&gt;true&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt; 5&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;email&lt;/span&gt;: &lt;span class=&quot;pc&quot;&gt;true&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt; 6&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;remote&lt;/span&gt;: &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;/users/email_available&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 7&lt;/span&gt;     },
&lt;span class=&quot;no&quot;&gt; 8&lt;/span&gt;     &lt;span class=&quot;ke&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[password]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;: {
&lt;span class=&quot;no&quot;&gt; 9&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;required&lt;/span&gt;: &lt;span class=&quot;pc&quot;&gt;true&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;10&lt;/strong&gt;&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;minlength&lt;/span&gt;: &lt;span class=&quot;i&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;11&lt;/span&gt;     }
&lt;span class=&quot;no&quot;&gt;12&lt;/span&gt;   },
&lt;span class=&quot;no&quot;&gt;13&lt;/span&gt;   &lt;span class=&quot;ke&quot;&gt;messages&lt;/span&gt;: {
&lt;span class=&quot;no&quot;&gt;14&lt;/span&gt;     &lt;span class=&quot;ke&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[email]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;: {
&lt;span class=&quot;no&quot;&gt;15&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;remote&lt;/span&gt;: &lt;span class=&quot;pd&quot;&gt;$&lt;/span&gt;.format(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;{0} has already been taken&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;16&lt;/span&gt;     }
&lt;span class=&quot;no&quot;&gt;17&lt;/span&gt;   },
&lt;span class=&quot;no&quot;&gt;18&lt;/span&gt;   &lt;span class=&quot;fu&quot;&gt;submitHandler&lt;/span&gt;: &lt;span class=&quot;kw&quot;&gt;function&lt;/span&gt;(form) {
&lt;span class=&quot;no&quot;&gt;19&lt;/span&gt;     &lt;span class=&quot;kw&quot;&gt;var&lt;/span&gt; form = &lt;span class=&quot;pd&quot;&gt;$&lt;/span&gt;(form);
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;20&lt;/strong&gt;&lt;/span&gt;     &lt;span class=&quot;kw&quot;&gt;var&lt;/span&gt; form_data = form.formParams()
&lt;span class=&quot;no&quot;&gt;21&lt;/span&gt;     &lt;span class=&quot;pd&quot;&gt;$&lt;/span&gt;.ajax({
&lt;span class=&quot;no&quot;&gt;22&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;url&lt;/span&gt;: form.attr(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;action&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;),
&lt;span class=&quot;no&quot;&gt;23&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;dataType&lt;/span&gt;: &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;json&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt;24&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;type&lt;/span&gt;: &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;POST&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt;25&lt;/span&gt;       &lt;span class=&quot;ke&quot;&gt;data&lt;/span&gt;: form_data,
&lt;span class=&quot;no&quot;&gt;26&lt;/span&gt;       &lt;span class=&quot;fu&quot;&gt;success&lt;/span&gt;: &lt;span class=&quot;kw&quot;&gt;function&lt;/span&gt; (data, textStatus, xhr) {
&lt;span class=&quot;no&quot;&gt;27&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;// code for cleaning up form and showing response here...&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;28&lt;/span&gt;       },
&lt;span class=&quot;no&quot;&gt;29&lt;/span&gt;       &lt;span class=&quot;fu&quot;&gt;error&lt;/span&gt;: &lt;span class=&quot;kw&quot;&gt;function&lt;/span&gt; (xhr, textStatus, errorThrown) {
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;30&lt;/strong&gt;&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;// code for showing errors here...&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;31&lt;/span&gt;       }
&lt;span class=&quot;no&quot;&gt;32&lt;/span&gt;     });
&lt;span class=&quot;no&quot;&gt;33&lt;/span&gt;   }
&lt;span class=&quot;no&quot;&gt;34&lt;/span&gt; });&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;If you have not used the Validation plugin before, it is a simple declarative way to validate forms. You specify the rules which apply to your form&amp;#8217;s input elements and they are checked as the user enters data and on submit. All the usual validations are provided by the plugin, including &lt;code&gt;remote&lt;/code&gt; which will make an Ajax call to your server to check the input. Messages for failed validations can be customized. And there are quite a few options available to change the behavior of the plugin.&lt;/p&gt;
&lt;p&gt;Now lets do this with a Backbone.js &lt;code&gt;View&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We will create a basic &lt;code&gt;FormView&lt;/code&gt; class to handle both create and edit, using a templated form. That is the extent of our brief for this blog post, a much more complete class is left as an exercise for the reader.&lt;/p&gt;
&lt;p&gt;Oh and we are using &lt;a href=&quot;http://jashkenas.github.com/coffee-script/&quot;&gt;CoffeeScript&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;cl&quot;&gt;FormView&lt;/span&gt; extends &lt;span class=&quot;co&quot;&gt;Backbone&lt;/span&gt;.&lt;span class=&quot;co&quot;&gt;View&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 2&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;initialize:&lt;/span&gt; -&amp;gt;
&lt;span class=&quot;no&quot;&gt; 3&lt;/span&gt;     &lt;span class=&quot;iv&quot;&gt;@template&lt;/span&gt; = _.template(&lt;span class=&quot;er&quot;&gt;$&lt;/span&gt;(&lt;span class=&quot;iv&quot;&gt;@templateSelector&lt;/span&gt;).html())
&lt;span class=&quot;no&quot;&gt; 4&lt;/span&gt;     &lt;span class=&quot;iv&quot;&gt;@validationOptions&lt;/span&gt; = &lt;span class=&quot;iv&quot;&gt;@options&lt;/span&gt;.validationOptions
&lt;span class=&quot;no&quot;&gt; 5&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 6&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;fetchParams:&lt;/span&gt; (form) -&amp;gt;
&lt;span class=&quot;no&quot;&gt; 7&lt;/span&gt;     rawdata = &lt;span class=&quot;er&quot;&gt;$&lt;/span&gt;(form).serialize()
&lt;span class=&quot;no&quot;&gt; 8&lt;/span&gt;     data = &lt;span class=&quot;gv&quot;&gt;$.&lt;/span&gt;deparam(rawdata)
&lt;span class=&quot;no&quot;&gt; 9&lt;/span&gt;     data[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;10&lt;/strong&gt;&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;11&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;render:&lt;/span&gt; -&amp;gt;
&lt;span class=&quot;no&quot;&gt;12&lt;/span&gt;     template_values = &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;iv&quot;&gt;@model&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;iv&quot;&gt;@model&lt;/span&gt;.toJSON() &lt;span class=&quot;r&quot;&gt;else&lt;/span&gt; {}
&lt;span class=&quot;no&quot;&gt;13&lt;/span&gt;     &lt;span class=&quot;er&quot;&gt;$&lt;/span&gt;(&lt;span class=&quot;iv&quot;&gt;@el&lt;/span&gt;).html(&lt;span class=&quot;iv&quot;&gt;@template&lt;/span&gt;(template_values))
&lt;span class=&quot;no&quot;&gt;14&lt;/span&gt;     opts = { &lt;span class=&quot;sy&quot;&gt;submitHandler:&lt;/span&gt; &lt;span class=&quot;iv&quot;&gt;@submit&lt;/span&gt; }
&lt;span class=&quot;no&quot;&gt;15&lt;/span&gt;     opts = _.extend(opts, &lt;span class=&quot;iv&quot;&gt;@validationOptions&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;16&lt;/span&gt;     &lt;span class=&quot;er&quot;&gt;$&lt;/span&gt;(&lt;span class=&quot;iv&quot;&gt;@el&lt;/span&gt;).find(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;form&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;).validate(opts)
&lt;span class=&quot;no&quot;&gt;17&lt;/span&gt;     this
&lt;span class=&quot;no&quot;&gt;18&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;19&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;submit:&lt;/span&gt; (form) =&amp;gt;
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;20&lt;/strong&gt;&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;iv&quot;&gt;@model&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;21&lt;/span&gt;       &lt;span class=&quot;iv&quot;&gt;@model&lt;/span&gt;.save(fetchParams(form))
&lt;span class=&quot;no&quot;&gt;22&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;23&lt;/span&gt;       &lt;span class=&quot;iv&quot;&gt;@collection&lt;/span&gt;.create(fetchParams(form))
&lt;span class=&quot;no&quot;&gt;24&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;25&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;cl&quot;&gt;User&lt;/span&gt; extends &lt;span class=&quot;co&quot;&gt;Backbone&lt;/span&gt;.&lt;span class=&quot;co&quot;&gt;Model&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;26&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;27&lt;/span&gt; users = new &lt;span class=&quot;co&quot;&gt;Collection&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;28&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;model:&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;User&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;29&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;url:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;/users&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;30&lt;/strong&gt;&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;31&lt;/span&gt; view = new &lt;span class=&quot;co&quot;&gt;FormView&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;32&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;collection:&lt;/span&gt; users
&lt;span class=&quot;no&quot;&gt;33&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;el:&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;$&lt;/span&gt;(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;#signup_form&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;34&lt;/span&gt;   &lt;span class=&quot;sy&quot;&gt;templateSelector:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;#new_user_form&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;35&lt;/span&gt;   validationOptions:
&lt;span class=&quot;no&quot;&gt;36&lt;/span&gt;     rules:
&lt;span class=&quot;no&quot;&gt;37&lt;/span&gt;       &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[email]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;:
&lt;span class=&quot;no&quot;&gt;38&lt;/span&gt;         &lt;span class=&quot;sy&quot;&gt;remote:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;/users/email_available&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;39&lt;/span&gt;       &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[password]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;:
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;40&lt;/strong&gt;&lt;/span&gt;         &lt;span class=&quot;sy&quot;&gt;minlength:&lt;/span&gt; &lt;span class=&quot;i&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;41&lt;/span&gt;     messages:
&lt;span class=&quot;no&quot;&gt;42&lt;/span&gt;       &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;user[email]&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;:
&lt;span class=&quot;no&quot;&gt;43&lt;/span&gt;         &lt;span class=&quot;sy&quot;&gt;remote:&lt;/span&gt; &lt;span class=&quot;gv&quot;&gt;$.&lt;/span&gt;format(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;{0} has already been taken&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;44&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;45&lt;/span&gt; view.render()&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;FormView&lt;/code&gt; class can handle either creating a new model or editing an existing model. When creating a new object pass in the &lt;code&gt;collection&lt;/code&gt; as an option, and when editing an existing model pass in the &lt;code&gt;model&lt;/code&gt; as an option. You need to specify the &lt;code&gt;el&lt;/code&gt; where the &lt;code&gt;FormView&lt;/code&gt; will render the form, and the &lt;code&gt;templateSelector&lt;/code&gt; that will identify the &lt;a href=&quot;http://documentcloud.github.com/underscore/#template&quot;&gt;Underscore.js template&lt;/a&gt;. And of course you need to specify the validation rules, messages, and options for the Validation plugin, but &lt;strong&gt;not&lt;/strong&gt; a &lt;code&gt;submitHandler&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Fire things up by calling &lt;code&gt;render&lt;/code&gt;, and our form will now validate and if successfully validated, submit. Done!&lt;/p&gt;
&lt;p&gt;Here are some things to note:&lt;/p&gt;
&lt;p&gt;We are using classes on the inputs to indicate the basic Validation rules to apply.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;validationOptions&lt;/code&gt; do not include the &lt;code&gt;submitHandler&lt;/code&gt;, which is added by the &lt;code&gt;FormView&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We are also using the &lt;code&gt;jquery.ba-bbq&lt;/code&gt; plugin for the &lt;code&gt;deparam&lt;/code&gt; method it adds to jQuery&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h2&gt;Heresy!&lt;/h2&gt;
&lt;p&gt;On to the heresy. MVC dogma would say that the model should be responsible for its validation, and here the view is doing the validation &amp;mdash; the Validation plugin is part of the &lt;code&gt;FormView&lt;/code&gt; view internals.&lt;/p&gt;
&lt;h3&gt;Pragmatism&lt;/h3&gt;
&lt;p&gt;The existing model validation scheme for Backbone.js is weak. There is no easy declarative way to validate models at the moment. I am hopeful that Derrick Bailey&amp;#8217;s &lt;a href=&quot;https://github.com/derickbailey/backbone.modelbinding&quot;&gt;Backbone.ModelBinding&lt;/a&gt; will eventually lead to an answer. On the other hand, the jQuery Validation plugin already works and works well with very little coding required.&lt;/p&gt;
&lt;h3&gt;Does &amp;lsquo;dogma&amp;rsquo; even apply?&lt;/h3&gt;
&lt;p&gt;The remote email validation does not fit neatly into the usual MVC validation scheme. If you have done this in Rails, you no doubt have written code that is not part of the normal validation process to achieve this. What is being validated is a single data field from a model independent of the model itself &amp;mdash; and Backbone.js is no different: &lt;code&gt;validate&lt;/code&gt; operates on a model instance.&lt;/p&gt;
&lt;p&gt;Another way to think of this is that the view is gathering and validating input before passing it onto the model. In this case, the validation is part of the behavior of the form and the individual inputs, with the view doing the availabilty check as soon as there is an email address entered by the user. Once the view is valid, the submit passes the data onto the model. And of course, the model on the server is doing its own validations. And the model on the client? It is a one-liner, just a data container for passing data cleanly along from the view (which is doing the interesting work) to the model on the server. The crux is that the input &amp;ldquo;validation&amp;rdquo; is substantially more than just an &amp;ldquo;email must be unique&amp;rdquo; validation on the model, it is the user experience around entering potentially incorrect data.&lt;/p&gt;
&lt;p&gt;I am not convinced that MVC is misplaced here. Given a different framework, the model&amp;#8217;s validations could be flexible enough to really accomodate this scenario. Another possiblity is that this MVC is widget-y and hidden within my Backbone.js view. But for the time being, I am happy to keep shipping and live with this heresy.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; Why is this not in jQuery? Why is something like this not a standalone plugin?&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Using Resque and Resque Scheduler on Heroku</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2011/04/03/using-resque-and-resque-scheduler-on-heroku.html" />
    
    <id>tag:blog.leshill.org,2011-04-03:1301886603</id>
    
    <published>2011-04-03T20:10:03-07:00</published>
    <updated>2011-04-03T20:10:03-07:00</updated>
    <content type="html">&lt;div class='update'&gt;
&lt;h2&gt;Updated! July 26, 2011&lt;/h2&gt;
&lt;p&gt;Now covers both the &lt;code&gt;Bamboo&lt;/code&gt; and &lt;code&gt;Cedar&lt;/code&gt; stacks and incorporates feedback from Scott Watermasysk and our own experiences using Resque on Heroku.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;When it comes to background processing, I use &lt;a href=&quot;https://github.com/defunkt/resque&quot;&gt;resque&lt;/a&gt; &amp;mdash; I do not even consider the other popular alternative &lt;a href=&quot;https://github.com/tobi/delayed_job&quot;&gt;delayed_job&lt;/a&gt;. I seem to be in good company, this is a tweet from &lt;a href=&quot;https://twitter.com/#!/tobi/status/11334664846&quot;&gt;@tobi&lt;/a&gt;, the author of &lt;code&gt;delayed_job&lt;/code&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I feel like I have to write a imatrix style email about delayed_job and resque&amp;#8230;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Unfortunately, on Heroku, the sanctioned way to do background processing is to use a worker with &lt;code&gt;delayed_job&lt;/code&gt;. Definitely not an option. A little googling turned up two blog posts&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; that give us almost all the pieces we need to do this very inexpensively&lt;sup class=&quot;footnote&quot; id=&quot;fnr2&quot;&gt;&lt;a href=&quot;#fn2&quot;&gt;2&lt;/a&gt;&lt;/sup&gt;. Getting this to work with &lt;code&gt;resque-scheduler&lt;/code&gt; was a little tricky, so I have documented the setup here.&lt;/p&gt;
&lt;p&gt;There are three parts to this blog post, using &lt;code&gt;resque&lt;/code&gt;, using &lt;code&gt;resque-scheduler&lt;/code&gt; on &lt;code&gt;Bamboo&lt;/code&gt;, and using &lt;code&gt;resque-scheduler&lt;/code&gt; on &lt;code&gt;Cedar&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;Resque&lt;/h2&gt;
&lt;p&gt;To start, we need a &lt;code&gt;Redis&lt;/code&gt; database to use, &lt;a href=&quot;http://redistogo.com&quot;&gt;RedisToGo&lt;/a&gt; offers a nano version for free. Add it to your Heroko app.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% heroku addons:add redistogo:nano&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To use &lt;code&gt;resque&lt;/code&gt;, add the gem.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; gem &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Make your class(es) work with &lt;code&gt;resque&lt;/code&gt;, and then extend the class(es) with &lt;code&gt;HerokuAutoScaler::AutoScaling&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt; 1&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;cl&quot;&gt;MyStuff&lt;/span&gt; &amp;lt; &lt;span class=&quot;co&quot;&gt;ActiveRecord&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;Base&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 2&lt;/span&gt;   extend &lt;span class=&quot;co&quot;&gt;HerokuAutoScaler&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;AutoScaling&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 3&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 4&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;queue&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 5&lt;/span&gt;     &lt;span class=&quot;sy&quot;&gt;:my_queue&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 6&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 7&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 8&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;perform&lt;/span&gt;(*args)
&lt;span class=&quot;no&quot;&gt; 9&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;# work done here&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;10&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;code&gt;HerokuResqueAutoscale&lt;/code&gt; should be somewhere in your load path (&lt;code&gt;app/models&lt;/code&gt; works.)&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;  1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# Based on the ideas from: http://blog.darkhax.com/2010/07/30/auto-scale-your-resque-workers-on-heroku&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  2&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;heroku&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  3&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;  4&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# Scale workers on Heroku automatically as your Resque queue grows.&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  5&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# Mixin the +AutoScaling+ module into your models to get the behavior.&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  6&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  7&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#   class MyModel &amp;lt; ActiveRecord::Base&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  8&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#     extend HerokuAutoScaler::AutoScaling&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;  9&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#   end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;10&lt;/strong&gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 11&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# And configure in an initializer +config/initializers/heroku_workers.rb+:&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 12&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 13&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#   HerokuAutoScaler.configure do&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 14&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#     scale_by {|pending| }&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 15&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#   end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 16&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 17&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# The default scaling is non-linear:&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 18&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# * 1 job =&amp;gt; 1 worker&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 19&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# * 15 jobs =&amp;gt; 2 workers&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;20&lt;/strong&gt;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# * 25 jobs =&amp;gt; 3 workers&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 21&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# * 40 jobs =&amp;gt; 4 workers&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 22&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# * 60+ jobs =&amp;gt; 5 workers&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 23&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;cl&quot;&gt;HerokuAutoScaler&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 24&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;cl&quot;&gt;AutoScaling&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 25&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;after_perform_scale_down&lt;/span&gt;(*args)
&lt;span class=&quot;no&quot;&gt; 26&lt;/span&gt;       &lt;span class=&quot;co&quot;&gt;HerokuAutoScaler&lt;/span&gt;.scale_down!
&lt;span class=&quot;no&quot;&gt; 27&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 28&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 29&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;after_enqueue_scale_up&lt;/span&gt;(*args)
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;30&lt;/strong&gt;&lt;/span&gt;       &lt;span class=&quot;co&quot;&gt;HerokuAutoScaler&lt;/span&gt;.scale_up!
&lt;span class=&quot;no&quot;&gt; 31&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 32&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 33&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;on_failure&lt;/span&gt;(e, *args)
&lt;span class=&quot;no&quot;&gt; 34&lt;/span&gt;       &lt;span class=&quot;co&quot;&gt;Rails&lt;/span&gt;.logger.info(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Resque Exception for [&lt;/span&gt;&lt;span class=&quot;il&quot;&gt;&lt;span class=&quot;idl&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.to_s&lt;span class=&quot;idl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;il&quot;&gt;&lt;span class=&quot;idl&quot;&gt;#{&lt;/span&gt;args.join(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;)&lt;span class=&quot;idl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;] : &lt;/span&gt;&lt;span class=&quot;il&quot;&gt;&lt;span class=&quot;idl&quot;&gt;#{&lt;/span&gt;e.to_s&lt;span class=&quot;idl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt; 35&lt;/span&gt;       &lt;span class=&quot;co&quot;&gt;HerokuAutoScaler&lt;/span&gt;.scale_down!
&lt;span class=&quot;no&quot;&gt; 36&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 37&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 38&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 39&lt;/span&gt;   extend &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;40&lt;/strong&gt;&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 41&lt;/span&gt;   attr_accessor &lt;span class=&quot;sy&quot;&gt;:ignore_scaling&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 42&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 43&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;clear_resque&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 44&lt;/span&gt;     &lt;span class=&quot;co&quot;&gt;Resque&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;Worker&lt;/span&gt;.all.each {|w| w.unregister_worker}
&lt;span class=&quot;no&quot;&gt; 45&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 46&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 47&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;configure&lt;/span&gt;(&amp;amp;block)
&lt;span class=&quot;no&quot;&gt; 48&lt;/span&gt;     instance_eval(&amp;amp;block) &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; block_given?
&lt;span class=&quot;no&quot;&gt; 49&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;50&lt;/strong&gt;&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 51&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;scale_by&lt;/span&gt;(&amp;amp;block)
&lt;span class=&quot;no&quot;&gt; 52&lt;/span&gt;     &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.scaling_block = block
&lt;span class=&quot;no&quot;&gt; 53&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 54&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 55&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;scale_down!&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 56&lt;/span&gt;     &lt;span class=&quot;co&quot;&gt;Rails&lt;/span&gt;.logger.info &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Scale down j:&lt;/span&gt;&lt;span class=&quot;il&quot;&gt;&lt;span class=&quot;idl&quot;&gt;#{&lt;/span&gt;job_count&lt;span class=&quot;idl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt; w:&lt;/span&gt;&lt;span class=&quot;il&quot;&gt;&lt;span class=&quot;idl&quot;&gt;#{&lt;/span&gt;resque_workers&lt;span class=&quot;idl&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 57&lt;/span&gt;     &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.heroku_workers = &lt;span class=&quot;i&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; job_count == &lt;span class=&quot;i&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; resque_workers == &lt;span class=&quot;i&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 58&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 59&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;60&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;scale_up!&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 61&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; ignore_scaling
&lt;span class=&quot;no&quot;&gt; 62&lt;/span&gt;     pending = job_count
&lt;span class=&quot;no&quot;&gt; 63&lt;/span&gt;     &lt;span class=&quot;pc&quot;&gt;self&lt;/span&gt;.heroku_workers = workers_for(pending) &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; pending &amp;gt; &lt;span class=&quot;i&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 64&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 65&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 66&lt;/span&gt;   private
&lt;span class=&quot;no&quot;&gt; 67&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 68&lt;/span&gt;   attr_accessor &lt;span class=&quot;sy&quot;&gt;:scaling_block&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 69&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;70&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;heroku&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 71&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;HEROKU_USER&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;] &amp;amp;&amp;amp; &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;HEROKU_PASSWORD&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;] &amp;amp;&amp;amp; &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;HEROKU_APP&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt; 72&lt;/span&gt;       &lt;span class=&quot;iv&quot;&gt;@heroku&lt;/span&gt; ||= &lt;span class=&quot;co&quot;&gt;Heroku&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;Client&lt;/span&gt;.new(&lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;HEROKU_USER&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;], &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;HEROKU_PASSWORD&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;])
&lt;span class=&quot;no&quot;&gt; 73&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 74&lt;/span&gt;       &lt;span class=&quot;pc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 75&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 76&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 77&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 78&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;heroku_workers=&lt;/span&gt;(qty)
&lt;span class=&quot;no&quot;&gt; 79&lt;/span&gt;     heroku.set_workers(&lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;HEROKU_APP&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;], qty) &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; heroku
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;80&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 81&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 82&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;job_count&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 83&lt;/span&gt;     &lt;span class=&quot;co&quot;&gt;Resque&lt;/span&gt;.info[&lt;span class=&quot;sy&quot;&gt;:pending&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt; 84&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 85&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; 86&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;resque_workers&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 87&lt;/span&gt;     &lt;span class=&quot;co&quot;&gt;Resque&lt;/span&gt;.info[&lt;span class=&quot;sy&quot;&gt;:working&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt; 88&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 89&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt; &lt;strong&gt;90&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;workers_for&lt;/span&gt;(pending_jobs)
&lt;span class=&quot;no&quot;&gt; 91&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; scaling_block
&lt;span class=&quot;no&quot;&gt; 92&lt;/span&gt;       scaling_block.call(pending_jobs)
&lt;span class=&quot;no&quot;&gt; 93&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 94&lt;/span&gt;       [
&lt;span class=&quot;no&quot;&gt; 95&lt;/span&gt;         { &lt;span class=&quot;sy&quot;&gt;:workers&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;c&quot;&gt;# This many workers&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 96&lt;/span&gt;           &lt;span class=&quot;sy&quot;&gt;:job_count&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# For this many jobs or more, until the next level&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt; 97&lt;/span&gt;       },
&lt;span class=&quot;no&quot;&gt; 98&lt;/span&gt;         { &lt;span class=&quot;sy&quot;&gt;:workers&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;2&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt; 99&lt;/span&gt;           &lt;span class=&quot;sy&quot;&gt;:job_count&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;15&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;100&lt;/strong&gt;&lt;/span&gt;       },
&lt;span class=&quot;no&quot;&gt;101&lt;/span&gt;         { &lt;span class=&quot;sy&quot;&gt;:workers&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;3&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt;102&lt;/span&gt;           &lt;span class=&quot;sy&quot;&gt;:job_count&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;25&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;103&lt;/span&gt;       },
&lt;span class=&quot;no&quot;&gt;104&lt;/span&gt;         { &lt;span class=&quot;sy&quot;&gt;:workers&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;4&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt;105&lt;/span&gt;           &lt;span class=&quot;sy&quot;&gt;:job_count&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;40&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;106&lt;/span&gt;       },
&lt;span class=&quot;no&quot;&gt;107&lt;/span&gt;         { &lt;span class=&quot;sy&quot;&gt;:workers&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;5&lt;/span&gt;,
&lt;span class=&quot;no&quot;&gt;108&lt;/span&gt;           &lt;span class=&quot;sy&quot;&gt;:job_count&lt;/span&gt; =&amp;gt; &lt;span class=&quot;i&quot;&gt;60&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;109&lt;/span&gt;       }
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;110&lt;/strong&gt;&lt;/span&gt;       ].reverse_each &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt; |scale_info|
&lt;span class=&quot;no&quot;&gt;111&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;# Run backwards so it gets set to the highest value first&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;112&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;# Otherwise if there were 70 jobs, it would get set to 1, then 2, then 3, etc&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;113&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;114&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;# If we have a job count greater than or equal to the job limit for this scale info&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;115&lt;/span&gt;         &lt;span class=&quot;r&quot;&gt;if&lt;/span&gt; pending_jobs &amp;gt;= scale_info[&lt;span class=&quot;sy&quot;&gt;:job_count&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;116&lt;/span&gt;           &lt;span class=&quot;r&quot;&gt;return&lt;/span&gt; scale_info[&lt;span class=&quot;sy&quot;&gt;:workers&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;117&lt;/span&gt;         &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;118&lt;/span&gt;       &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;119&lt;/span&gt;     &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;&lt;strong&gt;120&lt;/strong&gt;&lt;/span&gt;   &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;121&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Scaling works by calling into the &lt;code&gt;heroku&lt;/code&gt; gem and issuing commands to your Heroku application; you need to have the &lt;code&gt;heroku&lt;/code&gt; gem and your Heroku credentials available. Add the &lt;code&gt;heroku&lt;/code&gt; gem.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# needs to be in your deployment environment, not just dev!&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; gem &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;heroku&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;You need to add three &lt;em&gt;config&lt;/em&gt; variables to Heroku to allow your workers to auto-scale. Check out my previous Heroku &lt;a href=&quot;http://blog.leshill.org/blog/2010/11/02/heroku-environment-variables.html&quot;&gt;blog post&lt;/a&gt; for a neat way to manage your &lt;em&gt;config&lt;/em&gt; variables. Set the &lt;em&gt;config&lt;/em&gt; variables.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;HEROKU_APP = your_app
HEROKU_USER = your_user
HEROKU_PASSWORD = your_password&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Add this task file to &lt;code&gt;lib/tasks/resque.task&lt;/code&gt; to run as many normal &lt;code&gt;resque&lt;/code&gt; workers as needed.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque/tasks&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:setup&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;sy&quot;&gt;:environment&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt;   &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;QUEUE&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;] = &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;6&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;7&lt;/span&gt; desc &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Alias for resque:work (To run workers on Heroku)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;8&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;jobs:work&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:work&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Finally, we also need to make sure &lt;code&gt;resque&lt;/code&gt; does not get a stale db connection&lt;sup class=&quot;footnote&quot; id=&quot;fnr3&quot;&gt;&lt;a href=&quot;#fn3&quot;&gt;3&lt;/a&gt;&lt;/sup&gt;, add this to &lt;code&gt;config/initializers/resque.rb&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;Resque&lt;/span&gt;.after_fork = &lt;span class=&quot;co&quot;&gt;Proc&lt;/span&gt;.new { &lt;span class=&quot;co&quot;&gt;ActiveRecord&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;Base&lt;/span&gt;.establish_connection }&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Deploy, and watch your workers scale as needed!&lt;sup class=&quot;footnote&quot; id=&quot;fnr4&quot;&gt;&lt;a href=&quot;#fn4&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h2&gt;Resque Scheduler&lt;/h2&gt;
&lt;p&gt;Out of the box, &lt;code&gt;resque-scheduler&lt;/code&gt; will not work with our auto-scaling code because it is broken. Specifically, it does not invoke hooks (like &lt;code&gt;after_enqueue&lt;/code&gt;!) when adding jobs to the &lt;code&gt;resque&lt;/code&gt; queues. &lt;a href=&quot;https://twitter.com/l4rk&quot;&gt;@l4rk&lt;/a&gt; and I have submitted a patch that has been pulled in but does not look like it has been released as a gem yet. Thankfully, &lt;code&gt;bundler&lt;/code&gt; lets us specify the github repo directly.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; gem &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque-scheduler&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;sy&quot;&gt;require:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque_scheduler&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;sy&quot;&gt;git:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;git://github.com/bvandenbos/resque-scheduler&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;If you are using a schedule file, load it in an initializer &lt;code&gt;config/initializers/scheduler.rb&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;Resque&lt;/span&gt;.schedule = &lt;span class=&quot;co&quot;&gt;YAML&lt;/span&gt;.load_file(&lt;span class=&quot;co&quot;&gt;File&lt;/span&gt;.join(&lt;span class=&quot;co&quot;&gt;File&lt;/span&gt;.dirname(&lt;span class=&quot;pc&quot;&gt;__FILE__&lt;/span&gt;), &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;../resque_schedule.yml&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;))&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;h2&gt;Using &lt;code&gt;resque-scheduler&lt;/code&gt; on the &lt;code&gt;Bamboo&lt;/code&gt; stack&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;resque-scheduler&lt;/code&gt; works by having a long-running worker continually pushing jobs to the &lt;code&gt;resque&lt;/code&gt; queues as scheduled. The default &lt;code&gt;Bamboo&lt;/code&gt; stack on Heroku does not make any allowance for different worker types. This is a problem. When scaling down, Heroku has no way of knowing which worker is &amp;#8216;working&amp;#8217; or &amp;#8216;scheduling&amp;#8217; or &amp;#8216;idle&amp;#8217;.&lt;/p&gt;
&lt;p&gt;And the solution is not very clean. Use the &lt;code&gt;Cedar&lt;/code&gt; stack if you can (see below).&lt;/p&gt;
&lt;p&gt;The only way to isolate a long-running worker (the scheduler) from scaling workers is to use a second Heroku application instance to run the long-running worker. In our case, the easiest way to do this is to redeploy the same codebase to another Heroku instance and set a filter to redirect any http requests to the original app.&lt;/p&gt;
&lt;p&gt;There are four things to configure on your second Heroku instance:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;point to the same redis instance by setting the RedisToGo variable manually&lt;/li&gt;
	&lt;li&gt;make sure that the &lt;code&gt;HEROKU_APP&lt;/code&gt;, &lt;code&gt;HEROKU_USER&lt;/code&gt;, and &lt;code&gt;HEROKU_PASSWORD&lt;/code&gt; variables (explained earlier) are set identically (you want to affect the original Heroku instance)&lt;/li&gt;
	&lt;li&gt;use the Heroku app or console to run one worker&lt;/li&gt;
	&lt;li&gt;use the following task file&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque/tasks&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque_scheduler/tasks&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:setup&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;sy&quot;&gt;:environment&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:scheduler_setup&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;sy&quot;&gt;:environment&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;6&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;7&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;jobs:work&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:scheduler&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;h2&gt;Using the &lt;code&gt;Cedar&lt;/code&gt; stack on Heroku&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;Cedar&lt;/code&gt; stack on Heroku solves this problem by allowing you to define as many types of worker as you want using the &lt;a href=&quot;http://blog.heroku.com/archives/2011/6/20/the_new_heroku_1_process_model_procfile/&quot;&gt;Procfile&lt;/a&gt; which is new to &lt;code&gt;Cedar&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Add this to your &lt;code&gt;Procfile&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;sy&quot;&gt;worker:&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;QUEUE&lt;/span&gt;=* bundle exec rake resque&lt;span class=&quot;sy&quot;&gt;:work&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;sy&quot;&gt;scheduler:&lt;/span&gt; bundle exec rake resque&lt;span class=&quot;sy&quot;&gt;:scheduler&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Change your task file.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque/tasks&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque_scheduler/tasks&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:setup&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;sy&quot;&gt;:environment&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; task &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;resque:scheduler_setup&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;sy&quot;&gt;:environment&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;And run one scheduler worker.&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; heroku scale scheduler=&lt;span class=&quot;i&quot;&gt;1&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;h2&gt;Deploy!&lt;/h2&gt;
&lt;p&gt;When we put this all together, we have a &lt;em&gt;scheduler worker&lt;/em&gt; monitoring our scheduled/delayed jobs, and any number of workers working our &lt;code&gt;resque&lt;/code&gt; queues. Jobs are placed in our &lt;code&gt;resque&lt;/code&gt; queues either directly by our application, or by the &lt;em&gt;scheduler&lt;/em&gt; at the scheduled time.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; First, James Bracy of &lt;a href=&quot;http://redistogo.com&quot;&gt;RedisToGo&lt;/a&gt; wrote a nice &lt;a href=&quot;http://blog.redistogo.com/2010/07/26/resque-with-redis-to-go/&quot;&gt;blog post&lt;/a&gt; showing how to use Resque instead of delayed_job with Heroku. And Daniel Huckstep then wrote a great &lt;a href=&quot;http://blog.darkhax.com/2010/07/30/auto-scale-your-resque-workers-on-heroku&quot;&gt;blog post&lt;/a&gt; on a nifty way to auto-scale workers on Heroku.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn2&quot;&gt;&lt;a href=&quot;#fnr2&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; Almost, &lt;code&gt;resque-scheduler&lt;/code&gt; requires a dedicated worker running all the time, and that will cost some money on Heroku.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn3&quot;&gt;&lt;a href=&quot;#fnr3&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt; Adjust as needed if you are not using &lt;code&gt;ActiveRecord&lt;/code&gt;.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn4&quot;&gt;&lt;a href=&quot;#fnr4&quot;&gt;&lt;sup&gt;4&lt;/sup&gt;&lt;/a&gt; Occasionally, you will have two workers clearing the queues simultaneously. In this case, the scaling code will not scale down because it is not safe to do so and the scale down will have to wait until the next opportunity.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Is BDD Right for a Startup?</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2011/02/20/is-bdd-right-for-a-startup.html" />
    
    <id>tag:blog.leshill.org,2011-02-20:1298209946</id>
    
    <published>2011-02-20T05:52:26-08:00</published>
    <updated>2011-02-20T05:52:26-08:00</updated>
    <content type="html">&lt;p&gt;There is a thread over on &lt;a href=&quot;http://news.ycombinator.com/item?id=2240595&quot;&gt;Hacker News&lt;/a&gt; about this, and there is a question on &lt;a href=&quot;http://qr.ae/AeVm&quot;&gt;Quora&lt;/a&gt; about it as well.&lt;/p&gt;
&lt;p&gt;TL;DR : Team knows TDD/BDD? Use it!&lt;/p&gt;
&lt;p&gt;To me the answer is absolutely yes, with an important qualification. The&lt;br /&gt;
developers must be experienced with TDD/BDD. When the team is experienced with&lt;br /&gt;
TDD/BDD and knows the tools, idioms, anti-patterns, and effective&lt;br /&gt;
workflows it delivers better, higher quality, and more desirable results&lt;br /&gt;
faster.&lt;/p&gt;
&lt;p&gt;When the team does not know how to go about TDD/BDD effectively, their lack of&lt;br /&gt;
skill in driving features through testing will slow them down and will not&lt;br /&gt;
yield better results&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; &amp;#8212; this is not unexpected. It takes practice and&lt;br /&gt;
discipline to build testing skills.&lt;/p&gt;
&lt;p&gt;If you are at a startup, writing some code and asking the question &amp;#8220;Do we&lt;br /&gt;
TDD/BDD?&amp;#8221; &amp;#8212; it seems to me that you have already crossed the Rubicon and are&lt;br /&gt;
not going to be able to TDD/BDD effectively. The time to make that choice is&lt;br /&gt;
when you are assembling your team.&lt;/p&gt;
&lt;p&gt;Founding your startup now? TDD/BDD experience should be one of the criteria you&lt;br /&gt;
look for in your development team.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; In my experience, the efforts of someone new to TDD/BDD are usually&lt;br /&gt;
ineffective at delivering clean and valuable code.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Heroku Environment Variables</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2010/11/02/heroku-environment-variables.html" />
    
    <id>tag:blog.leshill.org,2010-11-01:1288670966</id>
    
    <published>2010-11-01T21:09:26-07:00</published>
    <updated>2010-11-01T21:09:26-07:00</updated>
    <content type="html">&lt;h1&gt;Also Known As: Config Vars&lt;/h1&gt;
&lt;p&gt;Deploying an app to &lt;a href=&quot;http://heroku.com&quot;&gt;Heroku&lt;/a&gt; is awesome. Really. If you have not yet done so, it is worth spending the few minutes to setup a simple Rails app and deploy to Heroku.&lt;/p&gt;
&lt;p&gt;Awesome! Unless you have a lot of local configuration (perhaps your app talks to many external systems and has lots of settings). Then it becomes a bit less awesome, but we can fix that!&lt;/p&gt;
&lt;p&gt;Heroku handles local configuration with something Heroku calls &lt;em&gt;config variables&lt;/em&gt;. They are effectively environment variables, but I will follow Heroku&amp;#8217;s lead and call them &lt;em&gt;config variables&lt;/em&gt;.&lt;/p&gt;
&lt;h2&gt;Local configurations before Heroku&lt;/h2&gt;
&lt;p&gt;Before &lt;a href=&quot;http://heroku.com&quot;&gt;Heroku&lt;/a&gt;, the issue of how to keep local configurations, like database settings (including passwords) and API tokens, was resolved by having a file that was not checked into source control, but that was avaiable in all environments.&lt;/p&gt;
&lt;p&gt;An example we are all familiar with is Capistrano. One (or more) YAML (usually) files are setup locally on each host: your local development box, the staging server, the production server.  On the deployment hosts (i.e. staging, production) these files are located in the Capistrano shared directory and symlinked during the deploy so that the application can read them to load any configurations.&lt;/p&gt;
&lt;h2&gt;Local configurations with Heroku&lt;/h2&gt;
&lt;p&gt;Heroku applications cannot use local storage in the same way. There is no directory available to store your applications configuration files locally; and you do not want them in source control&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Heroku instead provides each application with user defined config variables that are available in the your application&amp;#8217;s &lt;code&gt;ENV&lt;/code&gt; hash. If, for example, you are configuring &lt;code&gt;omniauth&lt;/code&gt; with Twitter support, you might have this code in &lt;strong&gt;config/initializers/omniauth.rb&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;Rails&lt;/span&gt;.application.config.middleware.use &lt;span class=&quot;co&quot;&gt;OmniAuth&lt;/span&gt;::&lt;span class=&quot;co&quot;&gt;Builder&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt;   provider &lt;span class=&quot;sy&quot;&gt;:twitter&lt;/span&gt;, &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;TWITTER_KEY&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;], &lt;span class=&quot;co&quot;&gt;ENV&lt;/span&gt;[&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;TWITTER_SECRET&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;]
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;r&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Your app will read the configuration from the &lt;code&gt;ENV&lt;/code&gt; hash. You use the &lt;code&gt;heroku&lt;/code&gt; command to set the config variables:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;heroku config:add TWITTER_KEY=key TWITTER_SECRET=secret --app myapp&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This quickly becomes painful if you have to do this many times on many Heroku applications. After googling around for a bit, I found one article by &lt;a href=&quot;http://tammersaleh.com/posts/managing-heroku-environment-variables-for-local-development&quot;&gt;Tammer Saleh&lt;/a&gt; that provided a bit of inspiration.&lt;/p&gt;
&lt;h1&gt;Managing Heroku config variables using a local YAML file&lt;/h1&gt;
&lt;p&gt;We can make things better by using a local file on your development machine to manage all the settings in one place.&lt;/p&gt;
&lt;p&gt;Lets save our configuration to &lt;code&gt;config/heroku.yml&lt;/code&gt; which looks like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apps:
  staging: myapp-staging
  production: myapp
development: &amp;amp;defaults
  admins: 'joe sue'
  domain_url: http://localhost:3000
  twitter_key: key
  twitter_secret: secret
test:
  &amp;lt;&amp;lt;: *defaults
staging:
  bundle_without: development:test
  admins: 'joe sue'
  domain_url: http://myapp-staging.heroku.com
  twitter_key: key
  twitter_secret: secret
production:
  bundle_without: development:test
  admins: 'joe sue'
  domain_url: http://myapp.heroku.com
  twitter_key: key
  twitter_secret: secret&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The file should seem familiar; it is organized very much like the Rails &lt;code&gt;database.yml&lt;/code&gt; file.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;apps&lt;/code&gt; key defines a mapping from an environment name like &lt;code&gt;staging&lt;/code&gt; to a Heroku application like &lt;code&gt;myapp-staging&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Each environment key has its own settings. Note that &lt;code&gt;development&lt;/code&gt; and &lt;code&gt;test&lt;/code&gt; are not named under the &lt;code&gt;apps&lt;/code&gt; key as they local and are not deployed to Heroku.&lt;/p&gt;
&lt;p&gt;This file &lt;strong&gt;is not checked in&lt;/strong&gt; and should be added to your &lt;code&gt;.gitignore&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;To load our YAML settings file at runtime, we have to modify &lt;code&gt;config/application.rb&lt;/code&gt; and add a new file: &lt;code&gt;config/heroku_env.rb&lt;/code&gt; (all files are on &lt;a href=&quot;http://github.com/leshill/heroku-thor&quot;&gt;github&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;We make the following modification to the top of  &lt;code&gt;config/application.rb&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;no&quot;&gt;1&lt;/span&gt; require &lt;span class=&quot;co&quot;&gt;File&lt;/span&gt;.expand_path(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;../boot&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;pc&quot;&gt;__FILE__&lt;/span&gt;)
&lt;span class=&quot;no&quot;&gt;2&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;3&lt;/span&gt; require &lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;rails&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;4&lt;/span&gt; 
&lt;span class=&quot;no&quot;&gt;5&lt;/span&gt; load(&lt;span class=&quot;co&quot;&gt;File&lt;/span&gt;.expand_path(&lt;span class=&quot;s&quot;&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;../heroku_env.rb&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;pc&quot;&gt;__FILE__&lt;/span&gt;))&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Our app is now reading our YAML file and populating the application&amp;#8217;s &lt;code&gt;ENV&lt;/code&gt; hash based our settings file when we run locally.&lt;/p&gt;
&lt;p&gt;To set the config variables on Heroku, we copy &lt;code&gt;heroku.thor&lt;/code&gt; (yes, &lt;a href=&quot;http://github.com/leshill/heroku-thor&quot;&gt;github&lt;/a&gt;) to our &lt;code&gt;lib/tasks&lt;/code&gt; directory.&lt;/p&gt;
&lt;p&gt;It defines two tasks for each of your Heroku apps: &lt;code&gt;config&lt;/code&gt; to set the config variables from the settings files, and &lt;code&gt;rack_env&lt;/code&gt; to set the &lt;code&gt;RACK_ENV&lt;/code&gt; config variable.&lt;/p&gt;
&lt;p&gt;We use &lt;code&gt;thor deploy:staging:config&lt;/code&gt; to setup our config variables on our Heroku staging application.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;% thor deploy:staging:config
heroku config:add ADMINS='joe sue' DOMAIN_URL='http://myappp-staging.heroku.com' TWITTER_KEY='key' TWITTER_SECRET='secret' --app myapp-staging
Adding config vars:
  ADMINS         =&amp;gt; joe sue
  DOMAIN_URL     =&amp;gt; http://myapp-staging.heroku.com
  TWITTER_KEY    =&amp;gt; key
  TWITTER_SECRET =&amp;gt; secret
Restarting app...done.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And your app is now configured.&lt;/p&gt;
&lt;h2&gt;Better?&lt;/h2&gt;
&lt;p&gt;I have found this approach to managing my Heroku apps useful. One way it can be improved is by extending the &lt;code&gt;thor&lt;/code&gt; file to include common Heroku commands such as deploys (and you could use &lt;code&gt;invoke&lt;/code&gt; to chain together the deploy and configuration settings).&lt;/p&gt;
&lt;p&gt;Still, I am not pleased. Mostly this is because I have not packaged this up nicely. The need for locally modified files makes this a candidate for a Rails generator, something I may do if I get the time.&lt;/p&gt;
&lt;p&gt;For now the raw source is up on &lt;a href=&quot;http://github.com/leshill/heroku-thor&quot;&gt;github&lt;/a&gt;.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; Really.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Everyone's first Rails app</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2010/09/23/diaspora.html" />
    
    <id>tag:blog.leshill.org,2010-09-23:1285253154</id>
    
    <published>2010-09-23T07:45:54-07:00</published>
    <updated>2010-09-23T07:45:54-07:00</updated>
    <content type="html">&lt;p&gt;There are some rumblings in the Ruby community now about the recently released &lt;a href=&quot;http://www.joindiaspora.com/&quot;&gt;Diaspora&lt;/a&gt; and the quality of its codebase.&lt;/p&gt;
&lt;p&gt;I took a look at it on the day it was released. What I saw was everyone&amp;#8217;s first Rails app. The code looked like it had been written directly after reading a tutorial or a book.&lt;/p&gt;
&lt;p&gt;This is not a bad thing. We all started with Rails and wrote an app like that.  It is the first step on the journey to mastery.&lt;/p&gt;
&lt;p&gt;Unfortunately for the Diaspora team, they have done this in public and with a great expectations and corresponding hype (Diaspora has been called a &lt;em&gt;Facebook Killer&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;Fortunately for the Diaspora team, they have done this in public with a &lt;a href=&quot;http://github.com/diaspora/diaspora&quot;&gt;github repository&lt;/a&gt; that others can contribute to&lt;sup class=&quot;footnote&quot; id=&quot;fnr1&quot;&gt;&lt;a href=&quot;#fn1&quot;&gt;1&lt;/a&gt;&lt;/sup&gt; and make better.&lt;/p&gt;
&lt;p class=&quot;footnote&quot; id=&quot;fn1&quot;&gt;&lt;a href=&quot;#fnr1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; Sort of. I, and others, would have preferred an MIT license.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Cucumber Tips</title>
    <link rel="alternate" type="text/html" href="http://blog.leshill.org/blog/2010/09/19/cucumber-tips.html" />
    
    <id>tag:blog.leshill.org,2010-09-19:1284953752</id>
    
    <published>2010-09-19T20:35:52-07:00</published>
    <updated>2010-09-19T20:35:52-07:00</updated>
    <content type="html">&lt;p&gt;As a happy &lt;a href=&quot;http://cukes.info&quot;&gt;Cucumber&lt;/a&gt; user, I am really glad to see that a few of my favorite Rubyists have recently blogged some tips for using &lt;strong&gt;Cucumber&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;Jonas Nicklas &lt;a href=&quot;http://elabs.se/blog/15-you-re-cuking-it-wrong&quot;&gt;You&amp;#8217;re Cuking It Wrong&lt;/a&gt;&lt;br /&gt;
Mislav Marohnić &lt;a href=&quot;http://mislav.uniqpath.com/2010/09/cuking-it-right/&quot;&gt;You&amp;#8217;re cuking it right&lt;/a&gt;&lt;br /&gt;
Bodaniel Jeanes &lt;a href=&quot;http://bjeanes.com/2010/09/19/selector-free-cucumber-scenarios&quot;&gt;Selector-Free Cucumber Scenarios&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Thanks guys!&lt;/p&gt;</content>
  </entry>
  
</feed>
