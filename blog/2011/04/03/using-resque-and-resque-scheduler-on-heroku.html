<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
  <meta content='text/html; charset=utf-8' http-equiv='content-type' />
  <meta content='Les Hill' name='author' />
  <title>
    Les Hill &mdash; Using Resque and Resque Scheduler on Heroku
  </title>
  <link href='/css/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
  <link href='/css/coderay.css' media='screen, projection' rel='stylesheet' type='text/css' />
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js' type='text/javascript'></script>
  <script src='/javascript/jquery.twitter.js' type='text/javascript'></script>
  <script src='/javascript/application.js' type='text/javascript'></script>
  <link href='http://feeds2.feedburner.com/leshill' rel='alternate' title='RSS feed' type='application/atom+xml' />
  <script type='text/javascript'>
    //<![CDATA[
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    //]]>
  </script>
  <script type='text/javascript'>
    //<![CDATA[
      try {
        var pageTracker = _gat._getTracker("UA-15974459-1");
        pageTracker._trackPageview();
      } catch(err) {}
    //]]>
  </script>
</head>
<body>
  <div class='site'>
    <div class='title'>
      <a href="/">Les Hill</a>
      <a href="http://github.com/leshill/" class="extra">github</a>
      <a href="http://twitter.com/leshill/" class="extra">twitter</a>
      <a href="http://facebook.com/leshill/" class="extra">facebook</a>
      <a href="http://www.linkedin.com/in/leshill/" class="extra">linked in</a>
      <a href="/archives.html" class="extra">archives</a>
    </div>
    <div id='post'>
      <div class='title'>
        <a href="/blog/2011/04/03/using-resque-and-resque-scheduler-on-heroku.html">Using Resque and Resque Scheduler on Heroku</a>
      </div>
      <div class='meta'>
        <abbr class='published' title='Sun Apr 03 20:10:03 -0700 2011'>
          Posted April 03, 2011
        </abbr>
      </div>
      <div class='content'>
        <div class='update'>&#x000A;<h2>Updated! July 26, 2011</h2>&#x000A;<p>Now covers both the <code>Bamboo</code> and <code>Cedar</code> stacks and incorporates feedback from Scott Watermasysk and our own experiences using Resque on Heroku.</p>&#x000A;</div>&#x000A;<p>When it comes to background processing, I use <a href="https://github.com/defunkt/resque">resque</a> &mdash; I do not even consider the other popular alternative <a href="https://github.com/tobi/delayed_job">delayed_job</a>. I seem to be in good company, this is a tweet from <a href="https://twitter.com/#!/tobi/status/11334664846">@tobi</a>, the author of <code>delayed_job</code>:</p>&#x000A;<blockquote>&#x000A;<p>I feel like I have to write a imatrix style email about delayed_job and resque&#8230;</p>&#x000A;</blockquote>&#x000A;<p>Unfortunately, on Heroku, the sanctioned way to do background processing is to use a worker with <code>delayed_job</code>. Definitely not an option. A little googling turned up two blog posts<sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup> that give us almost all the pieces we need to do this very inexpensively<sup class="footnote" id="fnr2"><a href="#fn2">2</a></sup>. Getting this to work with <code>resque-scheduler</code> was a little tricky, so I have documented the setup here.</p>&#x000A;<p>There are three parts to this blog post, using <code>resque</code>, using <code>resque-scheduler</code> on <code>Bamboo</code>, and using <code>resque-scheduler</code> on <code>Cedar</code>.</p>&#x000A;<h2>Resque</h2>&#x000A;<p>To start, we need a <code>Redis</code> database to use, <a href="http://redistogo.com">RedisToGo</a> offers a nano version for free. Add it to your Heroko app.</p>&#x000A;<pre><code>% heroku addons:add redistogo:nano</code></pre>&#x000A;<p>To use <code>resque</code>, add the gem.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> gem <span class="s"><span class="dl">&quot;</span><span class="k">resque</span><span class="dl">&quot;</span></span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>Make your class(es) work with <code>resque</code>, and then extend the class(es) with <code>HerokuAutoScaler::AutoScaling</code>.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no"> 1</span> <span class="r">class</span> <span class="cl">MyStuff</span> &lt; <span class="co">ActiveRecord</span>::<span class="co">Base</span>&#x000A;<span class="no"> 2</span>   extend <span class="co">HerokuAutoScaler</span>::<span class="co">AutoScaling</span>&#x000A;<span class="no"> 3</span> &#x000A;<span class="no"> 4</span>   <span class="r">def</span> <span class="pc">self</span>.<span class="fu">queue</span>&#x000A;<span class="no"> 5</span>     <span class="sy">:my_queue</span>&#x000A;<span class="no"> 6</span>   <span class="r">end</span>&#x000A;<span class="no"> 7</span> &#x000A;<span class="no"> 8</span>   <span class="r">def</span> <span class="pc">self</span>.<span class="fu">perform</span>(*args)&#x000A;<span class="no"> 9</span>     <span class="c"># work done here</span>&#x000A;<span class="no"><strong>10</strong></span>   <span class="r">end</span>&#x000A;<span class="no">11</span> <span class="r">end</span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p><code>HerokuResqueAutoscale</code> should be somewhere in your load path (<code>app/models</code> works.)</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">  1</span> <span class="c"># Based on the ideas from: http://blog.darkhax.com/2010/07/30/auto-scale-your-resque-workers-on-heroku</span>&#x000A;<span class="no">  2</span> require <span class="s"><span class="dl">'</span><span class="k">heroku</span><span class="dl">'</span></span>&#x000A;<span class="no">  3</span> &#x000A;<span class="no">  4</span> <span class="c"># Scale workers on Heroku automatically as your Resque queue grows.</span>&#x000A;<span class="no">  5</span> <span class="c"># Mixin the +AutoScaling+ module into your models to get the behavior.</span>&#x000A;<span class="no">  6</span> <span class="c">#</span>&#x000A;<span class="no">  7</span> <span class="c">#   class MyModel &lt; ActiveRecord::Base</span>&#x000A;<span class="no">  8</span> <span class="c">#     extend HerokuAutoScaler::AutoScaling</span>&#x000A;<span class="no">  9</span> <span class="c">#   end</span>&#x000A;<span class="no"> <strong>10</strong></span> <span class="c">#</span>&#x000A;<span class="no"> 11</span> <span class="c"># And configure in an initializer +config/initializers/heroku_workers.rb+:</span>&#x000A;<span class="no"> 12</span> <span class="c">#</span>&#x000A;<span class="no"> 13</span> <span class="c">#   HerokuAutoScaler.configure do</span>&#x000A;<span class="no"> 14</span> <span class="c">#     scale_by {|pending| }</span>&#x000A;<span class="no"> 15</span> <span class="c">#   end</span>&#x000A;<span class="no"> 16</span> <span class="c">#</span>&#x000A;<span class="no"> 17</span> <span class="c"># The default scaling is non-linear:</span>&#x000A;<span class="no"> 18</span> <span class="c"># * 1 job =&gt; 1 worker</span>&#x000A;<span class="no"> 19</span> <span class="c"># * 15 jobs =&gt; 2 workers</span>&#x000A;<span class="no"> <strong>20</strong></span> <span class="c"># * 25 jobs =&gt; 3 workers</span>&#x000A;<span class="no"> 21</span> <span class="c"># * 40 jobs =&gt; 4 workers</span>&#x000A;<span class="no"> 22</span> <span class="c"># * 60+ jobs =&gt; 5 workers</span>&#x000A;<span class="no"> 23</span> <span class="r">module</span> <span class="cl">HerokuAutoScaler</span>&#x000A;<span class="no"> 24</span>   <span class="r">module</span> <span class="cl">AutoScaling</span>&#x000A;<span class="no"> 25</span>     <span class="r">def</span> <span class="fu">after_perform_scale_down</span>(*args)&#x000A;<span class="no"> 26</span>       <span class="co">HerokuAutoScaler</span>.scale_down!&#x000A;<span class="no"> 27</span>     <span class="r">end</span>&#x000A;<span class="no"> 28</span> &#x000A;<span class="no"> 29</span>     <span class="r">def</span> <span class="fu">after_enqueue_scale_up</span>(*args)&#x000A;<span class="no"> <strong>30</strong></span>       <span class="co">HerokuAutoScaler</span>.scale_up!&#x000A;<span class="no"> 31</span>     <span class="r">end</span>&#x000A;<span class="no"> 32</span> &#x000A;<span class="no"> 33</span>     <span class="r">def</span> <span class="fu">on_failure</span>(e, *args)&#x000A;<span class="no"> 34</span>       <span class="co">Rails</span>.logger.info(<span class="s"><span class="dl">&quot;</span><span class="k">Resque Exception for [</span><span class="il"><span class="idl">#{</span><span class="pc">self</span>.to_s<span class="idl">}</span></span><span class="k">, </span><span class="il"><span class="idl">#{</span>args.join(<span class="s"><span class="dl">'</span><span class="k">, </span><span class="dl">'</span></span>)<span class="idl">}</span></span><span class="k">] : </span><span class="il"><span class="idl">#{</span>e.to_s<span class="idl">}</span></span><span class="dl">&quot;</span></span>)&#x000A;<span class="no"> 35</span>       <span class="co">HerokuAutoScaler</span>.scale_down!&#x000A;<span class="no"> 36</span>     <span class="r">end</span>&#x000A;<span class="no"> 37</span>   <span class="r">end</span>&#x000A;<span class="no"> 38</span> &#x000A;<span class="no"> 39</span>   extend <span class="pc">self</span>&#x000A;<span class="no"> <strong>40</strong></span> &#x000A;<span class="no"> 41</span>   attr_accessor <span class="sy">:ignore_scaling</span>&#x000A;<span class="no"> 42</span> &#x000A;<span class="no"> 43</span>   <span class="r">def</span> <span class="fu">clear_resque</span>&#x000A;<span class="no"> 44</span>     <span class="co">Resque</span>::<span class="co">Worker</span>.all.each {|w| w.unregister_worker}&#x000A;<span class="no"> 45</span>   <span class="r">end</span>&#x000A;<span class="no"> 46</span> &#x000A;<span class="no"> 47</span>   <span class="r">def</span> <span class="fu">configure</span>(&amp;block)&#x000A;<span class="no"> 48</span>     instance_eval(&amp;block) <span class="r">if</span> block_given?&#x000A;<span class="no"> 49</span>   <span class="r">end</span>&#x000A;<span class="no"> <strong>50</strong></span> &#x000A;<span class="no"> 51</span>   <span class="r">def</span> <span class="fu">scale_by</span>(&amp;block)&#x000A;<span class="no"> 52</span>     <span class="pc">self</span>.scaling_block = block&#x000A;<span class="no"> 53</span>   <span class="r">end</span>&#x000A;<span class="no"> 54</span> &#x000A;<span class="no"> 55</span>   <span class="r">def</span> <span class="fu">scale_down!</span>&#x000A;<span class="no"> 56</span>     <span class="co">Rails</span>.logger.info <span class="s"><span class="dl">&quot;</span><span class="k">Scale down j:</span><span class="il"><span class="idl">#{</span>job_count<span class="idl">}</span></span><span class="k"> w:</span><span class="il"><span class="idl">#{</span>resque_workers<span class="idl">}</span></span><span class="dl">&quot;</span></span>&#x000A;<span class="no"> 57</span>     <span class="pc">self</span>.heroku_workers = <span class="i">0</span> <span class="r">if</span> job_count == <span class="i">0</span> &amp;&amp; resque_workers == <span class="i">1</span>&#x000A;<span class="no"> 58</span>   <span class="r">end</span>&#x000A;<span class="no"> 59</span> &#x000A;<span class="no"> <strong>60</strong></span>   <span class="r">def</span> <span class="fu">scale_up!</span>&#x000A;<span class="no"> 61</span>     <span class="r">return</span> <span class="r">if</span> ignore_scaling&#x000A;<span class="no"> 62</span>     pending = job_count&#x000A;<span class="no"> 63</span>     <span class="pc">self</span>.heroku_workers = workers_for(pending) <span class="r">if</span> pending &gt; <span class="i">0</span>&#x000A;<span class="no"> 64</span>   <span class="r">end</span>&#x000A;<span class="no"> 65</span> &#x000A;<span class="no"> 66</span>   private&#x000A;<span class="no"> 67</span> &#x000A;<span class="no"> 68</span>   attr_accessor <span class="sy">:scaling_block</span>&#x000A;<span class="no"> 69</span> &#x000A;<span class="no"> <strong>70</strong></span>   <span class="r">def</span> <span class="fu">heroku</span>&#x000A;<span class="no"> 71</span>     <span class="r">if</span> <span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">HEROKU_USER</span><span class="dl">'</span></span>] &amp;&amp; <span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">HEROKU_PASSWORD</span><span class="dl">'</span></span>] &amp;&amp; <span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">HEROKU_APP</span><span class="dl">'</span></span>]&#x000A;<span class="no"> 72</span>       <span class="iv">@heroku</span> ||= <span class="co">Heroku</span>::<span class="co">Client</span>.new(<span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">HEROKU_USER</span><span class="dl">'</span></span>], <span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">HEROKU_PASSWORD</span><span class="dl">'</span></span>])&#x000A;<span class="no"> 73</span>     <span class="r">else</span>&#x000A;<span class="no"> 74</span>       <span class="pc">false</span>&#x000A;<span class="no"> 75</span>     <span class="r">end</span>&#x000A;<span class="no"> 76</span>   <span class="r">end</span>&#x000A;<span class="no"> 77</span> &#x000A;<span class="no"> 78</span>   <span class="r">def</span> <span class="fu">heroku_workers=</span>(qty)&#x000A;<span class="no"> 79</span>     heroku.set_workers(<span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">HEROKU_APP</span><span class="dl">'</span></span>], qty) <span class="r">if</span> heroku&#x000A;<span class="no"> <strong>80</strong></span>   <span class="r">end</span>&#x000A;<span class="no"> 81</span> &#x000A;<span class="no"> 82</span>   <span class="r">def</span> <span class="fu">job_count</span>&#x000A;<span class="no"> 83</span>     <span class="co">Resque</span>.info[<span class="sy">:pending</span>]&#x000A;<span class="no"> 84</span>   <span class="r">end</span>&#x000A;<span class="no"> 85</span> &#x000A;<span class="no"> 86</span>   <span class="r">def</span> <span class="fu">resque_workers</span>&#x000A;<span class="no"> 87</span>     <span class="co">Resque</span>.info[<span class="sy">:working</span>]&#x000A;<span class="no"> 88</span>   <span class="r">end</span>&#x000A;<span class="no"> 89</span> &#x000A;<span class="no"> <strong>90</strong></span>   <span class="r">def</span> <span class="fu">workers_for</span>(pending_jobs)&#x000A;<span class="no"> 91</span>     <span class="r">if</span> scaling_block&#x000A;<span class="no"> 92</span>       scaling_block.call(pending_jobs)&#x000A;<span class="no"> 93</span>     <span class="r">else</span>&#x000A;<span class="no"> 94</span>       [&#x000A;<span class="no"> 95</span>         { <span class="sy">:workers</span> =&gt; <span class="i">1</span>, <span class="c"># This many workers</span>&#x000A;<span class="no"> 96</span>           <span class="sy">:job_count</span> =&gt; <span class="i">1</span> <span class="c"># For this many jobs or more, until the next level</span>&#x000A;<span class="no"> 97</span>       },&#x000A;<span class="no"> 98</span>         { <span class="sy">:workers</span> =&gt; <span class="i">2</span>,&#x000A;<span class="no"> 99</span>           <span class="sy">:job_count</span> =&gt; <span class="i">15</span>&#x000A;<span class="no"><strong>100</strong></span>       },&#x000A;<span class="no">101</span>         { <span class="sy">:workers</span> =&gt; <span class="i">3</span>,&#x000A;<span class="no">102</span>           <span class="sy">:job_count</span> =&gt; <span class="i">25</span>&#x000A;<span class="no">103</span>       },&#x000A;<span class="no">104</span>         { <span class="sy">:workers</span> =&gt; <span class="i">4</span>,&#x000A;<span class="no">105</span>           <span class="sy">:job_count</span> =&gt; <span class="i">40</span>&#x000A;<span class="no">106</span>       },&#x000A;<span class="no">107</span>         { <span class="sy">:workers</span> =&gt; <span class="i">5</span>,&#x000A;<span class="no">108</span>           <span class="sy">:job_count</span> =&gt; <span class="i">60</span>&#x000A;<span class="no">109</span>       }&#x000A;<span class="no"><strong>110</strong></span>       ].reverse_each <span class="r">do</span> |scale_info|&#x000A;<span class="no">111</span>         <span class="c"># Run backwards so it gets set to the highest value first</span>&#x000A;<span class="no">112</span>         <span class="c"># Otherwise if there were 70 jobs, it would get set to 1, then 2, then 3, etc</span>&#x000A;<span class="no">113</span> &#x000A;<span class="no">114</span>         <span class="c"># If we have a job count greater than or equal to the job limit for this scale info</span>&#x000A;<span class="no">115</span>         <span class="r">if</span> pending_jobs &gt;= scale_info[<span class="sy">:job_count</span>]&#x000A;<span class="no">116</span>           <span class="r">return</span> scale_info[<span class="sy">:workers</span>]&#x000A;<span class="no">117</span>         <span class="r">end</span>&#x000A;<span class="no">118</span>       <span class="r">end</span>&#x000A;<span class="no">119</span>     <span class="r">end</span>&#x000A;<span class="no"><strong>120</strong></span>   <span class="r">end</span>&#x000A;<span class="no">121</span> <span class="r">end</span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>Scaling works by calling into the <code>heroku</code> gem and issuing commands to your Heroku application; you need to have the <code>heroku</code> gem and your Heroku credentials available. Add the <code>heroku</code> gem.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="c"># needs to be in your deployment environment, not just dev!</span>&#x000A;<span class="no">2</span> gem <span class="s"><span class="dl">&quot;</span><span class="k">heroku</span><span class="dl">&quot;</span></span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>You need to add three <em>config</em> variables to Heroku to allow your workers to auto-scale. Check out my previous Heroku <a href="http://blog.leshill.org/blog/2010/11/02/heroku-environment-variables.html">blog post</a> for a neat way to manage your <em>config</em> variables. Set the <em>config</em> variables.</p>&#x000A;<pre><code>HEROKU_APP = your_app&#x000A;HEROKU_USER = your_user&#x000A;HEROKU_PASSWORD = your_password</code></pre>&#x000A;<p>Add this task file to <code>lib/tasks/resque.task</code> to run as many normal <code>resque</code> workers as needed.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> require <span class="s"><span class="dl">'</span><span class="k">resque/tasks</span><span class="dl">'</span></span>&#x000A;<span class="no">2</span> &#x000A;<span class="no">3</span> task <span class="s"><span class="dl">&quot;</span><span class="k">resque:setup</span><span class="dl">&quot;</span></span> =&gt; <span class="sy">:environment</span> <span class="r">do</span>&#x000A;<span class="no">4</span>   <span class="co">ENV</span>[<span class="s"><span class="dl">'</span><span class="k">QUEUE</span><span class="dl">'</span></span>] = <span class="s"><span class="dl">'</span><span class="k">*</span><span class="dl">'</span></span>&#x000A;<span class="no">5</span> <span class="r">end</span>&#x000A;<span class="no">6</span> &#x000A;<span class="no">7</span> desc <span class="s"><span class="dl">&quot;</span><span class="k">Alias for resque:work (To run workers on Heroku)</span><span class="dl">&quot;</span></span>&#x000A;<span class="no">8</span> task <span class="s"><span class="dl">&quot;</span><span class="k">jobs:work</span><span class="dl">&quot;</span></span> =&gt; <span class="s"><span class="dl">&quot;</span><span class="k">resque:work</span><span class="dl">&quot;</span></span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>Finally, we also need to make sure <code>resque</code> does not get a stale db connection<sup class="footnote" id="fnr3"><a href="#fn3">3</a></sup>, add this to <code>config/initializers/resque.rb</code>.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="co">Resque</span>.after_fork = <span class="co">Proc</span>.new { <span class="co">ActiveRecord</span>::<span class="co">Base</span>.establish_connection }</pre></div>&#x000A;</div>&#x000A;&#x000A;<p>Deploy, and watch your workers scale as needed!<sup class="footnote" id="fnr4"><a href="#fn4">4</a></sup></p>&#x000A;<h2>Resque Scheduler</h2>&#x000A;<p>Out of the box, <code>resque-scheduler</code> will not work with our auto-scaling code because it is broken. Specifically, it does not invoke hooks (like <code>after_enqueue</code>!) when adding jobs to the <code>resque</code> queues. <a href="https://twitter.com/l4rk">@l4rk</a> and I have submitted a patch that has been pulled in but does not look like it has been released as a gem yet. Thankfully, <code>bundler</code> lets us specify the github repo directly.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> gem <span class="s"><span class="dl">'</span><span class="k">resque-scheduler</span><span class="dl">'</span></span>, <span class="sy">require:</span> <span class="s"><span class="dl">'</span><span class="k">resque_scheduler</span><span class="dl">'</span></span>, <span class="sy">git:</span> <span class="s"><span class="dl">'</span><span class="k">git://github.com/bvandenbos/resque-scheduler</span><span class="dl">'</span></span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>If you are using a schedule file, load it in an initializer <code>config/initializers/scheduler.rb</code></p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="co">Resque</span>.schedule = <span class="co">YAML</span>.load_file(<span class="co">File</span>.join(<span class="co">File</span>.dirname(<span class="pc">__FILE__</span>), <span class="s"><span class="dl">'</span><span class="k">../resque_schedule.yml</span><span class="dl">'</span></span>))</pre></div>&#x000A;</div>&#x000A;&#x000A;<h2>Using <code>resque-scheduler</code> on the <code>Bamboo</code> stack</h2>&#x000A;<p><code>resque-scheduler</code> works by having a long-running worker continually pushing jobs to the <code>resque</code> queues as scheduled. The default <code>Bamboo</code> stack on Heroku does not make any allowance for different worker types. This is a problem. When scaling down, Heroku has no way of knowing which worker is &#8216;working&#8217; or &#8216;scheduling&#8217; or &#8216;idle&#8217;.</p>&#x000A;<p>And the solution is not very clean. Use the <code>Cedar</code> stack if you can (see below).</p>&#x000A;<p>The only way to isolate a long-running worker (the scheduler) from scaling workers is to use a second Heroku application instance to run the long-running worker. In our case, the easiest way to do this is to redeploy the same codebase to another Heroku instance and set a filter to redirect any http requests to the original app.</p>&#x000A;<p>There are four things to configure on your second Heroku instance:</p>&#x000A;<ul>&#x000A;	<li>point to the same redis instance by setting the RedisToGo variable manually</li>&#x000A;	<li>make sure that the <code>HEROKU_APP</code>, <code>HEROKU_USER</code>, and <code>HEROKU_PASSWORD</code> variables (explained earlier) are set identically (you want to affect the original Heroku instance)</li>&#x000A;	<li>use the Heroku app or console to run one worker</li>&#x000A;	<li>use the following task file</li>&#x000A;</ul>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> require <span class="s"><span class="dl">'</span><span class="k">resque/tasks</span><span class="dl">'</span></span>&#x000A;<span class="no">2</span> require <span class="s"><span class="dl">'</span><span class="k">resque_scheduler/tasks</span><span class="dl">'</span></span>&#x000A;<span class="no">3</span> &#x000A;<span class="no">4</span> task <span class="s"><span class="dl">&quot;</span><span class="k">resque:setup</span><span class="dl">&quot;</span></span> =&gt; <span class="sy">:environment</span>&#x000A;<span class="no">5</span> task <span class="s"><span class="dl">&quot;</span><span class="k">resque:scheduler_setup</span><span class="dl">&quot;</span></span> =&gt; <span class="sy">:environment</span>&#x000A;<span class="no">6</span> &#x000A;<span class="no">7</span> task <span class="s"><span class="dl">&quot;</span><span class="k">jobs:work</span><span class="dl">&quot;</span></span> =&gt; <span class="s"><span class="dl">&quot;</span><span class="k">resque:scheduler</span><span class="dl">&quot;</span></span></pre></div>&#x000A;</div>&#x000A;&#x000A;<h2>Using the <code>Cedar</code> stack on Heroku</h2>&#x000A;<p>The <code>Cedar</code> stack on Heroku solves this problem by allowing you to define as many types of worker as you want using the <a href="http://blog.heroku.com/archives/2011/6/20/the_new_heroku_1_process_model_procfile/">Procfile</a> which is new to <code>Cedar</code>.</p>&#x000A;<p>Add this to your <code>Procfile</code></p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="sy">worker:</span> <span class="co">QUEUE</span>=* bundle exec rake resque<span class="sy">:work</span>&#x000A;<span class="no">2</span> <span class="sy">scheduler:</span> bundle exec rake resque<span class="sy">:scheduler</span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>Change your task file.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> require <span class="s"><span class="dl">'</span><span class="k">resque/tasks</span><span class="dl">'</span></span>&#x000A;<span class="no">2</span> require <span class="s"><span class="dl">'</span><span class="k">resque_scheduler/tasks</span><span class="dl">'</span></span>&#x000A;<span class="no">3</span> &#x000A;<span class="no">4</span> task <span class="s"><span class="dl">&quot;</span><span class="k">resque:setup</span><span class="dl">&quot;</span></span> =&gt; <span class="sy">:environment</span>&#x000A;<span class="no">5</span> task <span class="s"><span class="dl">&quot;</span><span class="k">resque:scheduler_setup</span><span class="dl">&quot;</span></span> =&gt; <span class="sy">:environment</span></pre></div>&#x000A;</div>&#x000A;&#x000A;<p>And run one scheduler worker.</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> heroku scale scheduler=<span class="i">1</span></pre></div>&#x000A;</div>&#x000A;&#x000A;<h2>Deploy!</h2>&#x000A;<p>When we put this all together, we have a <em>scheduler worker</em> monitoring our scheduled/delayed jobs, and any number of workers working our <code>resque</code> queues. Jobs are placed in our <code>resque</code> queues either directly by our application, or by the <em>scheduler</em> at the scheduled time.</p>&#x000A;<p class="footnote" id="fn1"><a href="#fnr1"><sup>1</sup></a> First, James Bracy of <a href="http://redistogo.com">RedisToGo</a> wrote a nice <a href="http://blog.redistogo.com/2010/07/26/resque-with-redis-to-go/">blog post</a> showing how to use Resque instead of delayed_job with Heroku. And Daniel Huckstep then wrote a great <a href="http://blog.darkhax.com/2010/07/30/auto-scale-your-resque-workers-on-heroku">blog post</a> on a nifty way to auto-scale workers on Heroku.</p>&#x000A;<p class="footnote" id="fn2"><a href="#fnr2"><sup>2</sup></a> Almost, <code>resque-scheduler</code> requires a dedicated worker running all the time, and that will cost some money on Heroku.</p>&#x000A;<p class="footnote" id="fn3"><a href="#fnr3"><sup>3</sup></a> Adjust as needed if you are not using <code>ActiveRecord</code>.</p>&#x000A;<p class="footnote" id="fn4"><a href="#fnr4"><sup>4</sup></a> Occasionally, you will have two workers clearing the queues simultaneously. In this case, the scaling code will not scale down because it is not safe to do so and the scale down will have to wait until the next opportunity.</p>
      </div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script type='text/javascript'>
          var disqus_shortname = 'leshill';
          var disqus_identifier = '/blog/2011/04/03/using-resque-and-resque-scheduler-on-heroku.html';
          var disqus_url = 'http://blog.leshill.org/blog/2011/04/03/using-resque-and-resque-scheduler-on-heroku.html';
          <!-- * * * DON'T EDIT BELOW THIS LINE * * */ -->
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>
          Please enable JavaScript to view the
          <a href='http://disqus.com/?ref_noscript'>
            comments powered by Disqus.
          </a>
        </noscript>
        <a class='dsq-brlink' href='http://disqus.com'>
          blog comments powered by
          <span class='logo-disqus'>
            Disqus
          </span>
        </a>
      </div>
    </div>
    <div class='footer'>
      <div class='contact'>
        <p>
          Les Hill
          <br />
          Developer @ <a href="http://pictureofhealth.com/">Picture of Health</a>
          <br />
          les (at) picutreofhealth (dot) com
        </p>
      </div>
      <div class='rss'>
        <a href='http://feeds2.feedburner.com/leshill'>
          <img alt='Subscribe to RSS Feed' src='/images/feed-icon-28x28.png' />
        </a>
      </div>
    </div>
    <div class='colophon'>
      <p>
        Thanks to <a href="http://tom.preston-werner.com/">Tom Preston-Werner</a>
        for the CSS layout, <a href="http://webby.rubyforge.org/">Webby</a> for
        the blog renderer, and
        <a href="http://github.com/blog/272-github-pages">GitHub Pages</a> for
        the blog hosting.
      </p>
      <div class='copyright'>
        <p>
          Les Hill &copy; 2008&ndash;2011
        </p>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/leshill/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
  </div>
</body>
