<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
  <meta content='text/html; charset=utf-8' http-equiv='content-type' />
  <meta content='Les Hill' name='author' />
  <title>
    Les Hill &mdash; Blog
  </title>
  <link href='/css/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
  <link href='/css/coderay.css' media='screen, projection' rel='stylesheet' type='text/css' />
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js' type='text/javascript'></script>
  <script src='/javascript/jquery.twitter.js' type='text/javascript'></script>
  <script src='/javascript/application.js' type='text/javascript'></script>
  <link href='http://feeds2.feedburner.com/leshill' rel='alternate' title='RSS feed' type='application/atom+xml' />
</head>
<body>
  <div class='site'>
    <div class='title'>
      <a href="/">Les Hill</a>
      <a href="http://github.com/leshill/" class="extra">github</a>
      <a href="http://twitter.com/leshill/" class="extra">twitter</a>
      <a href="http://facebook.com/leshill/" class="extra">facebook</a>
      <a href="http://www.linkedin.com/in/leshill/" class="extra">linked in</a>
      <a href="/archives.html" class="extra">archives</a>
    </div>
    <div id='post'>
      <div class='title'>
        <a href="/blog/2009/11/17/ensure-with-explicit-return.html">Ensure With Explicit Return</a>
      </div>
      <div class='meta'>
        <abbr class='published' title='Tue Nov 17 12:30:31 -0500 2009'>
          Posted November 17, 2009
        </abbr>
      </div>
      <div class='content'>
        <p>Quick! What does the following method do when <code>thing.method_that_might_raise!</code> raises <code>SomeAppException</code>?  And why is this a code smell?</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="r">def</span> <span class="fu">some_method</span>&#x000A;<span class="no">2</span>   thing.method_that_might_raise!&#x000A;<span class="no">3</span> <span class="r">ensure</span>&#x000A;<span class="no">4</span>   <span class="r">return</span> thing&#x000A;<span class="no">5</span> <span class="r">end</span></pre></div>&#x000A;</div>&#x000A;<p>Before giving the answers to these two questions, let&#8217;s go over what <code>ensure</code> does.</p>&#x000A;<p>The <code>ensure</code> clause in Ruby is run regardless of whether a block has thrown an exception or not.  A simple example is opening a file<sup class="footnote"><a href="#fn1">1</a></sup>:</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no"> 1</span> <span class="r">def</span> <span class="fu">file_open_with_auto_close</span>(name, mode = <span class="s"><span class="dl">'</span><span class="k">w</span><span class="dl">'</span></span>, &amp;block)&#x000A;<span class="no"> 2</span>   f = <span class="co">File</span>.open(name, mode)&#x000A;<span class="no"> 3</span>   puts <span class="s"><span class="dl">&quot;</span><span class="k">calling your block</span><span class="dl">&quot;</span></span>&#x000A;<span class="no"> 4</span>   <span class="r">yield</span> f&#x000A;<span class="no"> 5</span> <span class="r">ensure</span>&#x000A;<span class="no"> 6</span>   <span class="r">if</span> f&#x000A;<span class="no"> 7</span>     f.close&#x000A;<span class="no"> 8</span>     puts <span class="s"><span class="dl">&quot;</span><span class="k">file safely closed</span><span class="dl">&quot;</span></span>&#x000A;<span class="no"> 9</span>   <span class="r">end</span>&#x000A;<span class="no"><strong>10</strong></span> <span class="r">end</span>&#x000A;<span class="no">11</span> &#x000A;<span class="no">12</span> file_open_with_auto_close(<span class="s"><span class="dl">'</span><span class="k">test</span><span class="dl">'</span></span>) <span class="r">do</span> |file|&#x000A;<span class="no">13</span>   file &lt;&lt; <span class="s"><span class="dl">'</span><span class="k">data</span><span class="dl">'</span></span>&#x000A;<span class="no">14</span>   raise <span class="s"><span class="dl">'</span><span class="k">exception raised</span><span class="dl">'</span></span>&#x000A;<span class="no">15</span> <span class="r">end</span>&#x000A;<span class="no">16</span> <span class="c">#</span>&#x000A;<span class="no">17</span> <span class="c">#calling your block</span>&#x000A;<span class="no">18</span> <span class="c">#file safely closed</span>&#x000A;<span class="no">19</span> <span class="c">#RuntimeError: exception raised</span>&#x000A;<span class="no"><strong>20</strong></span> <span class="c">#  from (irb):14</span>&#x000A;<span class="no">21</span> <span class="c">#  from (irb):4:in `file_open_with_auto_close'</span>&#x000A;<span class="no">22</span> <span class="c">#  from (irb):12</span></pre></div>&#x000A;</div>&#x000A;<p>Even if there is an exception while processing the file, like the one we <code>raise</code> on line 14, <code>ensure</code> allows us to close the file.</p>&#x000A;<p>After the <code>ensure</code> clause has run, Ruby either continues the exception handling (in this case <code>irb</code> rescues it and gives us a stack trace) or continues executing the block.</p>&#x000A;<p><strong>Except</strong> if you have an explicit <code>return</code> statement in your <code>ensure</code> clause.</p>&#x000A;<p>Let&#8217;s take a look at the difference in <code>irb</code>, first without an explicit <code>return</code> statement:</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no"> 1</span> <span class="r">def</span> <span class="fu">ensure_without_return</span>&#x000A;<span class="no"> 2</span>   <span class="r">yield</span>&#x000A;<span class="no"> 3</span> <span class="r">ensure</span>&#x000A;<span class="no"> 4</span>   puts <span class="s"><span class="dl">'</span><span class="k">ensure</span><span class="dl">'</span></span>&#x000A;<span class="no"> 5</span>   <span class="pc">true</span>&#x000A;<span class="no"> 6</span> <span class="r">end</span>&#x000A;<span class="no"> 7</span> &#x000A;<span class="no"> 8</span> ensure_without_return { puts <span class="s"><span class="dl">'</span><span class="k">block</span><span class="dl">'</span></span>; <span class="pc">false</span> }&#x000A;<span class="no"> 9</span> <span class="c">#</span>&#x000A;<span class="no"><strong>10</strong></span> <span class="c">#block</span>&#x000A;<span class="no">11</span> <span class="c">#ensure</span>&#x000A;<span class="no">12</span> <span class="c">#=&gt; false</span>&#x000A;<span class="no">13</span> <span class="c">#</span>&#x000A;<span class="no">14</span> ensure_without_return { raise <span class="s"><span class="dl">'</span><span class="k">exception raised</span><span class="dl">'</span></span>; puts <span class="s"><span class="dl">'</span><span class="k">block</span><span class="dl">'</span></span>; <span class="pc">false</span> }&#x000A;<span class="no">15</span> <span class="c">#</span>&#x000A;<span class="no">16</span> <span class="c">#ensure</span>&#x000A;<span class="no">17</span> <span class="c">#RuntimeError: exception raised</span>&#x000A;<span class="no">18</span> <span class="c">#  from (irb):21</span>&#x000A;<span class="no">19</span> <span class="c">#  from (irb):16:in `ensure_without_return'</span>&#x000A;<span class="no"><strong>20</strong></span> <span class="c">#  from (irb):21</span></pre></div>&#x000A;</div>&#x000A;<p>Note that although the <code>ensure</code> clause is run after the block from line 8, it has not changed the return value of the method.</p>&#x000A;<p>And now with an explicit <code>return</code> statement:</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no"> 1</span> <span class="r">def</span> <span class="fu">ensure_with_return</span>&#x000A;<span class="no"> 2</span>   <span class="r">yield</span>&#x000A;<span class="no"> 3</span> <span class="r">ensure</span>&#x000A;<span class="no"> 4</span>   puts <span class="s"><span class="dl">'</span><span class="k">ensure</span><span class="dl">'</span></span>&#x000A;<span class="no"> 5</span>   <span class="r">return</span> <span class="pc">true</span>&#x000A;<span class="no"> 6</span> <span class="r">end</span>&#x000A;<span class="no"> 7</span> &#x000A;<span class="no"> 8</span> ensure_with_return { puts <span class="s"><span class="dl">'</span><span class="k">block</span><span class="dl">'</span></span>; <span class="pc">false</span> }&#x000A;<span class="no"> 9</span> <span class="c">#</span>&#x000A;<span class="no"><strong>10</strong></span> <span class="c">#block</span>&#x000A;<span class="no">11</span> <span class="c">#ensure</span>&#x000A;<span class="no">12</span> <span class="c">#=&gt; true</span>&#x000A;<span class="no">13</span> <span class="c">#</span>&#x000A;<span class="no">14</span> ensure_with_return { raise <span class="s"><span class="dl">'</span><span class="k">exception raised</span><span class="dl">'</span></span>; puts <span class="s"><span class="dl">'</span><span class="k">block</span><span class="dl">'</span></span>; <span class="pc">false</span> }&#x000A;<span class="no">15</span> <span class="c">#</span>&#x000A;<span class="no">16</span> <span class="c">#ensure</span>&#x000A;<span class="no">17</span> <span class="c">#=&gt; true</span></pre></div>&#x000A;</div>&#x000A;<p>The first thing to note is that the return of the method is now determined by the <code>return</code> statement in the <code>ensure</code> clause on line 5.</p>&#x000A;<p>The second thing to note is that the explicit <code>return</code> statement acts as an implicit <code>rescue</code> clause, allowing the code to resume as if no exception had been raised.</p>&#x000A;<p>Summarizing:</p>&#x000A;<ul>&#x000A;	<li>an <code>ensure</code> clause runs whether an exception is raised or not</li>&#x000A;	<li>an <code>ensure</code> clause without an explicit <code>return</code> statement does not alter the return value</li>&#x000A;	<li>using the explicit <code>return</code> changes the control flow as if a <code>rescue Exception</code> clause was in place before the <code>ensure</code> clause</li>&#x000A;</ul>&#x000A;<p>Back to our original questions.  You should now know what the method does when <code>thing.method_that_might_raise!</code> raises <code>SomeAppException</code>.</p>&#x000A;<p>But why is this a code smell?  Consider the following code:</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="r">def</span> <span class="fu">some_method</span>&#x000A;<span class="no">2</span>   thing.method_that_might_raise!&#x000A;<span class="no">3</span> <span class="r">rescue</span> <span class="co">Exception</span>&#x000A;<span class="no">4</span>   <span class="c"># we have rescued all possible exceptions</span>&#x000A;<span class="no">5</span> <span class="r">ensure</span>&#x000A;<span class="no">6</span>   <span class="r">return</span> thing&#x000A;<span class="no">7</span> <span class="r">end</span></pre></div>&#x000A;</div>&#x000A;<p>Line 3 is a code smell.  Rescuing all exceptions is not desirable.  From our exploration of <code>ensure</code> we can see that this code is the equivalent of the original code.</p>&#x000A;<p>Can we refactor it? Yes. Yes we can.</p>&#x000A;<p>When we can recover from <code>SomeAppException</code>, we can just <code>rescue</code>:</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="r">def</span> <span class="fu">some_method</span>&#x000A;<span class="no">2</span>   <span class="r">begin</span>&#x000A;<span class="no">3</span>     thing.method_that_might_raise!&#x000A;<span class="no">4</span>   <span class="r">rescue</span> <span class="co">SomeAppException</span> =&gt; e&#x000A;<span class="no">5</span>     <span class="c"># do something clever here</span>&#x000A;<span class="no">6</span>   <span class="r">end</span>&#x000A;<span class="no">7</span>   thing&#x000A;<span class="no">8</span> <span class="r">end</span></pre></div>&#x000A;</div>&#x000A;<p>And when we cannot recover from <code>SomeAppException</code>, we just let the exception propagate up the call stack:</p>&#x000A;<div class="CodeRay">&#x000A;  <div class="code"><pre><span class="no">1</span> <span class="r">def</span> <span class="fu">some_method</span>&#x000A;<span class="no">2</span>   thing.method_that_might_raise!&#x000A;<span class="no">3</span>   thing&#x000A;<span class="no">4</span> <span class="r">end</span></pre></div>&#x000A;</div>&#x000A;<p class="footnote" id="fn1"><sup>1</sup> <code>File.open</code> already does this.</p><!-- #hashrocket -->
      </div>
      <div class='comments'>
        <div id='disqus_thread'></div>
        <script type='text/javascript'>
          //<![CDATA[
            var disqus_url = '/blog/2009/11/17/ensure-with-explicit-return.html';
          //]]>
        </script>
        <script src='http://disqus.com/forums/leshill/embed.js' type='text/javascript'></script>
        <noscript>
          <a href="http://leshill.disqus.com/?url=ref">View the discussion thread.</a>
        </noscript>
        <a class='dsq-brlink' href='http://disqus.com'>
          blog comments powered by
          <span class='logo-disqus'>
            Disqus
          </span>
        </a>
      </div>
    </div>
    <div class='postlist'>
      <div class='title'>
        <a href="/archives.html">Blog Posts</a>
      </div>
      <ul class='posts'>
        <li>
          <span>
            15 Nov 2009
          </span>
          &raquo;
          <a href="/blog/2009/11/15/simplified-layout.html">Simplified Layout</a>
        </li>
        <li>
          <span>
            11 Oct 2009
          </span>
          &raquo;
          <a href="/blog/2009/10/11/the-simplest-thing-that-could-possibly-work-with-gems.html">The Simplest Thing That Could Possibly Work (With Gems)</a>
        </li>
        <li>
          <span>
            09 Oct 2009
          </span>
          &raquo;
          <a href="/blog/2009/10/09/and-v.html">and vs &amp;&amp; - Fight!</a>
        </li>
        <li>
          <span>
            29 Sep 2009
          </span>
          &raquo;
          <a href="/blog/2009/09/29/best-practice-no-chains-in-controllers.html">Best Practice: No Chains in Controllers</a>
        </li>
        <li>
          <span>
            05 Aug 2009
          </span>
          &raquo;
          <a href="/blog/2009/08/05/update-for-stub-chain-for-mocha.html">Update for stub_chain for Mocha</a>
        </li>
        <li>
          <span>
            01 Jul 2009
          </span>
          &raquo;
          <a href="/blog/2009/07/01/bouncy-bots.html">Bouncy Bots!</a>
        </li>
        <li>
          <span>
            27 Jun 2009
          </span>
          &raquo;
          <a href="/blog/2009/06/27/semantic-list-markup-with-will-paginate.html">Semantic List Markup with will_paginate</a>
        </li>
        <li>
          <span>
            10 Jun 2009
          </span>
          &raquo;
          <a href="/blog/2009/06/10/default-options-with-ruby.html">Default Options With Ruby</a>
        </li>
        <li>
          <span>
            03 Jun 2009
          </span>
          &raquo;
          <a href="/blog/2009/06/03/truncating-html.html">Truncating HTML</a>
        </li>
        <li>
          <span>
            28 May 2009
          </span>
          &raquo;
          <a href="/blog/2009/05/28/aws-s3-bucket-copy.html">AWS S3 Bucket Copy</a>
        </li>
      </ul>
    </div>
    <div class='title'>
      &raquo; <a href="/archives.html">More Blog Posts</a>
    </div>
    <div class='footer'>
      <div class='contact'>
        <p>
          Les Hill
          <br />
          Software adventurer @ <a href="http://hashrocket.com/">Hashrocket</a>
          <br />
          les (at) hashrocket (dot) com
        </p>
      </div>
      <div class='rss'>
        <a href='http://feeds2.feedburner.com/leshill'>
          <img alt='Subscribe to RSS Feed' src='/images/feed-icon-28x28.png' />
        </a>
      </div>
    </div>
    <div class='colophon'>
      <p>
        Thanks to <a href="http://tom.preston-werner.com/">Tom Preston-Werner</a>
        for the CSS layout, <a href="http://webby.rubyforge.org/">Webby</a> for
        the blog renderer, and
        <a href="http://github.com/blog/272-github-pages">GitHub Pages</a> for
        the blog hosting.
      </p>
      <div class='copyright'>
        <p>
          Les Hill &copy; 2008&ndash;2009
        </p>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        (function() {
          var links = document.getElementsByTagName('a');
          var query = '?';
          for(var i = 0; i < links.length; i++) {
            if(links[i].href.indexOf('#disqus_thread') >= 0) {
              query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
            }
          }
          document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/leshill/get_num_replies.js' + query + '"></' + 'script>');
        })();
      //]]>
    </script>
  </div>
</body>
